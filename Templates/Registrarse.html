{% extends "BrainRush_Master.html" %}

{% block title %}Brain RUSH - Registrarse{% endblock %}

{% block extra_css %}
<style>
.register-page {
    min-height: calc(100vh - 80px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl) 0;
}

.register-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    padding: var(--space-xxl);
    width: 100%;
    max-width: 500px;
    position: relative;
    overflow: hidden;
}

.register-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-secondary);
}

.register-header {
    text-align: center;
    margin-bottom: var(--space-xxl);
}

.register-title {
    font-family: var(--font-primary);
    font-size: 2.5rem;
    background: var(--gradient-secondary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
}

.register-subtitle {
    color: var(--gray);
    font-size: 1rem;
    font-weight: 600;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
}

.form-group {
    margin-bottom: var(--space-lg);
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-weight: 600;
    color: var(--dark);
    margin-bottom: var(--space-sm);
    font-size: 0.9rem;
}

.form-input, .form-select {
    width: 100%;
    padding: var(--space-md);
    border: 2px solid rgba(0,0,0,0.1);
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-family: var(--font-secondary);
    transition: var(--transition-smooth);
    background: rgba(255,255,255,0.8);
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--secondary-color);
    background: white;
    box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
}

.register-btn {
    width: 100%;
    padding: var(--space-lg);
    background: var(--gradient-secondary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-smooth);
    margin-bottom: var(--space-lg);
}

.register-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.login-link {
    text-align: center;
}

.login-link a {
    color: var(--secondary-color);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition-fast);
}

.login-link a:hover {
    color: var(--primary-color);
}

.step-indicator {
    display: flex;
    justify-content: center;
    gap: var(--space-md);
    margin-bottom: var(--space-xxl);
}

.step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.1);
    color: var(--gray);
    font-weight: 600;
    transition: var(--transition-smooth);
}

.step.active {
    background: var(--gradient-secondary);
    color: white;
}

.step.completed {
    background: var(--gradient-primary);
    color: white;
}

.requirements {
    background: rgba(69, 183, 209, 0.1);
    border: 1px solid var(--accent-color);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
}

.requirements-title {
    color: var(--dark);
    font-size: 0.9rem;
    font-weight: 700;
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.requirement {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.85rem;
    color: var(--gray);
    margin-bottom: var(--space-sm);
}

.requirement.valid {
    color: var(--success-color);
}

.requirement i {
    width: 16px;
    text-align: center;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .register-card {
        margin: var(--space-md);
        padding: var(--space-xl);
    }
    
    .register-title {
        font-size: 2rem;
    }
    
    .step-indicator {
        gap: var(--space-sm);
    }
    
    .step {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="register-page">
    <div class="register-card animate-fadeIn">
        <div class="register-header">
            <h1 class="register-title">¬°√önete a Brain RUSH!</h1>
            <p class="register-subtitle">Crea tu cuenta y comienza tu aventura de aprendizaje</p>
        </div>

        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
        </div>

        <form action="{{ url_for('registrarse') }}" method="POST" id="registerForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="nombre" class="form-label">
                        <i class="fas fa-user"></i>
                        Nombre
                    </label>
                    <input type="text" id="nombre" name="nombre" required class="form-input" placeholder="Tu nombre">
                </div>
                
                <div class="form-group">
                    <label for="apellidos" class="form-label">
                        <i class="fas fa-user"></i>
                        Apellidos
                    </label>
                    <input type="text" id="apellidos" name="apellidos" required class="form-input" placeholder="Tus apellidos">
                </div>
            </div>

            <div class="form-group full-width">
                <label for="email" class="form-label">
                    <i class="fas fa-envelope"></i>
                    Correo Electr√≥nico Institucional
                </label>
                <input type="email" id="email" name="email" required class="form-input" placeholder="tu.nombre@usat.pe">
                <div class="requirement" id="req-email-domain" style="margin-top: 0.5rem; display: none;">
                    <i class="fas fa-times"></i>
                    <span>Debe ser un correo @usat.pe o @usat.edu.pe</span>
                </div>
            </div>

            <div class="form-group full-width">
                <label for="tipo_usuario" class="form-label">
                    <i class="fas fa-user-tag"></i>
                    Tipo de Usuario
                </label>
                <select id="tipo_usuario" name="tipo_usuario" required class="form-select">
                    <option value="">Selecciona tu rol</option>
                    <option value="estudiante">üéì Estudiante</option>
                    <option value="docente">üë®‚Äçüè´ Docente</option>
                </select>
            </div>

            <div class="form-group full-width">
                <label for="password" class="form-label">
                    <i class="fas fa-lock"></i>
                    Contrase√±a
                </label>
                <input type="password" id="password" name="password" required class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div class="requirements">
                <h4 class="requirements-title">
                    <i class="fas fa-shield-alt"></i>
                    Requisitos de Contrase√±a
                </h4>
                <div class="requirement" id="req-length">
                    <i class="fas fa-times"></i>
                    <span>M√≠nimo 8 caracteres</span>
                </div>
                <div class="requirement" id="req-uppercase">
                    <i class="fas fa-times"></i>
                    <span>Al menos una may√∫scula</span>
                </div>
                <div class="requirement" id="req-lowercase">
                    <i class="fas fa-times"></i>
                    <span>Al menos una min√∫scula</span>
                </div>
                <div class="requirement" id="req-number">
                    <i class="fas fa-times"></i>
                    <span>Al menos un n√∫mero</span>
                </div>
            </div>

            <div class="form-group full-width">
                <label for="confirm_password" class="form-label">
                    <i class="fas fa-lock"></i>
                    Confirmar Contrase√±a
                </label>
                <input type="password" id="confirm_password" name="confirm_password" required class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <div class="requirement" id="req-match" style="margin-top: 0.5rem; display: none;">
                    <i class="fas fa-times"></i>
                    <span>Las contrase√±as deben coincidir</span>
                </div>
            </div>

            <button type="submit" class="register-btn" id="submitBtn" disabled>
                <i class="fas fa-user-plus"></i>
                Crear Cuenta
            </button>
        </form>

        <div class="login-link">
            <p>¬øYa tienes cuenta? <a href="{{ url_for('login') }}">¬°Inicia sesi√≥n aqu√≠!</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar el token CSRF para todas las peticiones AJAX
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    // Agregar el token CSRF a todas las peticiones fetch
    const originalFetch = window.fetch;
    window.fetch = function() {
        let [url, config] = arguments;
        if (config === undefined) {
            config = {};
        }
        if (config.headers === undefined) {
            config.headers = {};
        }
        config.headers['X-CSRFToken'] = csrfToken;
        return originalFetch(url, config);
    };

    const form = document.getElementById('registerForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const emailInput = document.getElementById('email');
    const submitBtn = document.getElementById('submitBtn');
    
    // Campos para validaci√≥n de pasos
    const step1Fields = ['nombre', 'apellidos'];
    const step2Fields = ['email', 'tipo_usuario'];
    const step3Fields = ['password', 'confirm_password'];
    
    // Elementos de requisitos
    const requirements = {
        length: document.getElementById('req-length'),
        uppercase: document.getElementById('req-uppercase'),
        lowercase: document.getElementById('req-lowercase'),
        number: document.getElementById('req-number'),
        match: document.getElementById('req-match'),
        emailDomain: document.getElementById('req-email-domain')
    };
    
    // Validaci√≥n de dominio de correo
    emailInput.addEventListener('input', function() {
        const email = this.value.toLowerCase();
        const dominiosPermitidos = ['@usat.pe', '@usat.edu.pe'];
        const dominioValido = dominiosPermitidos.some(dominio => email.endsWith(dominio));
        
        if (email.length > 0) {
            requirements.emailDomain.style.display = 'flex';
            updateRequirement('emailDomain', dominioValido);
        } else {
            requirements.emailDomain.style.display = 'none';
        }
        
        validateForm();
        updateSteps();
    });

    
    // Validaci√≥n de confirmaci√≥n de contrase√±a
    confirmPasswordInput.addEventListener('input', function() {
        const password = passwordInput.value;
        const confirmPassword = this.value;
        
        // Mostrar indicador de coincidencia solo si hay texto en ambos campos
        if (confirmPassword.length > 0 && password.length > 0) {
            requirements.match.style.display = 'flex';
            const passwordsMatch = password === confirmPassword;
            updateRequirement('match', passwordsMatch);
        } else {
            requirements.match.style.display = 'none';
        }
        
        validateForm();
        updateSteps();
    });
    
    // Tambi√©n actualizar cuando se cambie la contrase√±a principal
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Verificar longitud
        updateRequirement('length', password.length >= 8);
        
        // Verificar may√∫scula
        updateRequirement('uppercase', /[A-Z]/.test(password));
        
        // Verificar min√∫scula
        updateRequirement('lowercase', /[a-z]/.test(password));
        
        // Verificar n√∫mero
        updateRequirement('number', /\d/.test(password));
        
        // Actualizar indicador de coincidencia si hay texto en confirmar
        if (confirmPassword.length > 0 && password.length > 0) {
            requirements.match.style.display = 'flex';
            const passwordsMatch = password === confirmPassword;
            updateRequirement('match', passwordsMatch);
        } else {
            requirements.match.style.display = 'none';
        }
        
        validateForm();
        updateSteps();
    });
    
    // Validar campos en tiempo real
    form.addEventListener('input', function() {
        updateSteps();
        validateForm();
    });
    
    function updateRequirement(type, isValid) {
        const req = requirements[type];
        const icon = req.querySelector('i');
        
        if (isValid) {
            req.classList.add('valid');
            icon.className = 'fas fa-check';
        } else {
            req.classList.remove('valid');
            icon.className = 'fas fa-times';
        }
    }
    
    function updateSteps() {
        const steps = [
            { element: document.getElementById('step1'), fields: step1Fields },
            { element: document.getElementById('step2'), fields: step2Fields },
            { element: document.getElementById('step3'), fields: step3Fields }
        ];
        
        steps.forEach((step, index) => {
            const isComplete = step.fields.every(fieldName => {
                const field = document.getElementById(fieldName);
                return field && field.value.trim() !== '';
            });
            
            if (isComplete) {
                step.element.classList.remove('active');
                step.element.classList.add('completed');
                if (index < steps.length - 1) {
                    steps[index + 1].element.classList.add('active');
                }
            } else {
                step.element.classList.remove('completed');
                if (index === 0 || steps[index - 1].element.classList.contains('completed')) {
                    step.element.classList.add('active');
                }
            }
        });
    }
    
    function validateForm() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const email = emailInput.value.toLowerCase();
        
        // Verificar todos los requisitos de contrase√±a
        const passwordValid = password.length >= 8 && 
                            /[A-Z]/.test(password) && 
                            /[a-z]/.test(password) && 
                            /\d/.test(password);
        
        // Verificar que las contrase√±as coincidan
        const passwordsMatch = password === confirmPassword && password !== '';
        
        // Verificar dominio del correo
        const dominiosPermitidos = ['@usat.pe', '@usat.edu.pe'];
        const emailValido = dominiosPermitidos.some(dominio => email.endsWith(dominio));
        
        // Verificar que todos los campos est√©n llenos
        const allFieldsFilled = [...step1Fields, ...step2Fields, ...step3Fields].every(fieldName => {
            const field = document.getElementById(fieldName);
            return field && field.value.trim() !== '';
        });
        
        // Habilitar/deshabilitar bot√≥n de submit
        if (allFieldsFilled && passwordValid && passwordsMatch && emailValido) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
        } else {
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.6';
        }
    }
    
    // Animaci√≥n al enviar formulario
    form.addEventListener('submit', function(e) {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const email = emailInput.value.toLowerCase();
        
        // Validaci√≥n del dominio de correo
        const dominiosPermitidos = ['@usat.pe', '@usat.edu.pe'];
        const emailValido = dominiosPermitidos.some(dominio => email.endsWith(dominio));
        
        if (!emailValido) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Correo no permitido',
                text: 'Solo se permiten correos institucionales con dominio @usat.pe o @usat.edu.pe',
                confirmButtonColor: '#4ECDC4',
                background: 'linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,240,255,0.95))',
                customClass: {
                    popup: 'animate-fadeIn'
                }
            });
            return false;
        }
        
        // Validaci√≥n final antes de enviar
        if (password !== confirmPassword) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Contrase√±as no coinciden',
                text: 'Las contrase√±as que ingresaste no son iguales. Por favor, verifica e intenta nuevamente.',
                confirmButtonColor: '#4ECDC4',
                background: 'linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,240,255,0.95))',
                customClass: {
                    popup: 'animate-fadeIn'
                }
            });
            return false;
        }
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando cuenta...';
        submitBtn.disabled = true;
    });
});
</script>
{% endblock %}
