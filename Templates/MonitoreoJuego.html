{% extends "BrainRush_Master.html" %}

{% block title %}Brain RUSH - Monitoreo de Sala{% endblock %}

{% block extra_css %}
<style>
.monitoreo-page {
    padding: 1.5rem 0;
}

.sala-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 2rem;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

.sala-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.info-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 1.5rem;
    padding: 1.5rem;
    text-align: center;
    border: 2px solid rgba(79, 70, 229, 0.1);
}

.pin-display {
    background: linear-gradient(135deg, #FF6B35, #4ECDC4);
    color: white;
    font-size: 3rem;
    font-weight: bold;
    letter-spacing: 0.2em;
    padding: 1.5rem;
    border-radius: 1.5rem;
    text-align: center;
    margin: 1.5rem 0;
    cursor: pointer;
}

.control-panel {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 2rem;
    padding: 2rem;
    margin-bottom: 1.5rem;
}

.control-btn {
    padding: 1rem 2rem;
    border: none;
    border-radius: 1.5rem;
    font-weight: 600;
    margin: 0.5rem;
    cursor: pointer;
}

.btn-success {
    background: linear-gradient(135deg, rgb(34, 197, 94), rgb(16, 185, 129));
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, rgb(239, 68, 68), rgb(220, 38, 38));
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container monitoreo-page">
    <div class="sala-header">
        <div class="sala-info">
            <div class="info-card">
                <h3>Sala ID</h3>
                <p>{{ sala.id }}</p>
            </div>
            <div class="info-card">
                <h3>Participantes</h3>
                <p>{{ participantes|length }}</p>
            </div>
        </div>
        
        <div class="pin-display" onclick="copiarCodigo()">
            Código: {{ sala.pin_sala }}
        </div>
    </div>

    <div class="control-panel">
        <h2>Panel de Control</h2>
        <button class="control-btn btn-success" onclick="iniciarJuego()">Iniciar Juego</button>
        <button class="control-btn btn-danger" onclick="finalizarJuego()">Finalizar</button>
        <a href="{{ url_for('mis_cuestionarios') }}" class="control-btn" style="background: #ccc; color: #333; text-decoration: none;">Volver</a>
    </div>

    <!-- Panel de Grupos -->
    <div class="control-panel" id="panel-grupos">
        <h2>⚙️ Configurar Grupos</h2>
        <div id="config-grupos">
            <p style="margin-bottom: 1rem; color: rgba(30,30,30,0.7);">Puedes crear grupos para dividir a los participantes. Cada estudiante seleccionará su grupo al unirse.</p>
            <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                <label for="num-grupos-input">Número de grupos:</label>
                <input type="number" id="num-grupos-input" min="2" max="10" value="2" style="padding: 0.5rem; border: 2px solid #ccc; border-radius: 0.5rem; width: 80px; text-align: center;">
                <button class="control-btn btn-success" onclick="habilitarGrupos()">✔️ Crear Grupos</button>
            </div>
        </div>
        <div id="grupos-container" style="display: none; margin-top: 1.5rem;">
            <h3 style="margin-bottom: 1rem;">Grupos Creados</h3>
            <div id="grupos-list"></div>
        </div>
    </div>

    <div class="control-panel">
        <h2>Participantes (<span id="participantes-count">{{ participantes|length }}</span>)</h2>
        <div id="participantes-container">
            {% if participantes %}
                <div id="participantes-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    {% for participante in participantes %}
                    <div class="participante-card" style="background: rgba(79, 70, 229, 0.1); border-radius: 1rem; padding: 1rem; text-align: center;">
                        <h4>{{ participante.nombre_participante }}</h4>
                        <p style="color: #4F46E5; font-weight: 600;">{{ participante.estado|title }}</p>
                        <small>Unido: {{ participante.fecha_union.strftime('%H:%M:%S') if participante.fecha_union else 'N/A' }}</small>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div id="no-participantes" style="text-align: center; padding: 2rem;">
                    <p>No hay participantes aún</p>
                    <p>Los estudiantes aparecerán cuando se unan con el código {{ sala.pin_sala }}</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const codigoSala = "{{ sala.pin_sala }}";
const SALA_ID = {{ sala.id }};

let gruposHabilitados = false;

// Habilitar grupos: envía solicitud al servidor para crear grupos
async function habilitarGrupos() {
    const numGrupos = parseInt(document.getElementById('num-grupos-input').value);
    if (numGrupos < 2 || numGrupos > 10) {
        alert('Ingresa un número válido de grupos (2-10)');
        return;
    }

    if (!confirm(`¿Crear ${numGrupos} grupos?`)) return;

    try {
        const response = await fetch(`/sala/${SALA_ID}/configurar-grupos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ num_grupos: numGrupos })
        });
        const data = await response.json();
        if (data.success) {
            alert(`✅ Se crearon ${data.grupos_creados} grupos`);
            gruposHabilitados = true;
            document.getElementById('config-grupos').style.display = 'none';
            document.getElementById('grupos-container').style.display = 'block';
            await cargarGrupos();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error habilitando grupos:', error);
        alert('Error al crear grupos');
    }
}

// Cargar grupos desde el servidor
async function cargarGrupos() {
    try {
        const response = await fetch(`/api/sala/${SALA_ID}/grupos`);
        const data = await response.json();
        if (data.success && data.grupos.length > 0) {
            gruposHabilitados = true;
            mostrarGrupos(data.grupos);
        }
    } catch (error) {
        console.error('Error cargando grupos:', error);
    }
}

// Mostrar grupos en el DOM
function mostrarGrupos(grupos) {
    const container = document.getElementById('grupos-list');
    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
    grupos.forEach(g => {
        html += `
            <div class="grupo-card" data-grupo-id="${g.id_grupo}" style="background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 1rem; padding: 1rem; text-align: center;">
                <h4 style="color: rgb(21, 128, 61);">${g.nombre_grupo}</h4>
                <p id="grupo-${g.id_grupo}-count" style="font-size: 0.9rem; color: rgba(30,30,30,0.7);">0 estudiantes</p>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// Actualizar participantes en tiempo real
function actualizarParticipantes() {
    fetch(`/api/participantes/${codigoSala}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const countElement = document.getElementById('participantes-count');
                const containerElement = document.getElementById('participantes-container');
                
                countElement.textContent = data.total;
                
                // Contar participantes por grupo si los grupos están habilitados
                if (gruposHabilitados) {
                    const gruposCuentas = {};
                    data.participantes.forEach(p => {
                        if (p.id_grupo) {
                            gruposCuentas[p.id_grupo] = (gruposCuentas[p.id_grupo] || 0) + 1;
                        }
                    });
                    // Actualizar contadores en las tarjetas de grupos
                    Object.keys(gruposCuentas).forEach(grupoId => {
                        const countEl = document.getElementById(`grupo-${grupoId}-count`);
                        if (countEl) {
                            const count = gruposCuentas[grupoId];
                            countEl.textContent = `${count} estudiante${count !== 1 ? 's' : ''}`;
                        }
                    });
                }
                
                if (data.participantes.length > 0) {
                    let html = '<div id="participantes-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">';
                    
                    data.participantes.forEach(participante => {
                        const grupoBadge = participante.nombre_grupo ? 
                            `<span style="background: rgba(34, 197, 94, 0.2); color: rgb(21, 128, 61); padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.85rem; display: inline-block; margin-top: 0.5rem;">👥 ${participante.nombre_grupo}</span>` : 
                            '';
                        html += `
                            <div class="participante-card" style="background: rgba(79, 70, 229, 0.1); border-radius: 1rem; padding: 1rem; text-align: center;">
                                <h4>${participante.nombre}</h4>
                                <p style="color: #4F46E5; font-weight: 600;">${participante.estado.charAt(0).toUpperCase() + participante.estado.slice(1)}</p>
                                <small>Unido: ${new Date(participante.fecha_union).toLocaleTimeString()}</small>
                                ${grupoBadge}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    containerElement.innerHTML = html;
                } else {
                    containerElement.innerHTML = `
                        <div id="no-participantes" style="text-align: center; padding: 2rem;">
                            <p>No hay participantes aún</p>
                            <p>Los estudiantes aparecerán cuando se unan con el código ${codigoSala}</p>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Error actualizando participantes:', error);
        });
}

// Actualizar cada 3 segundos
setInterval(actualizarParticipantes, 3000);

// Cargar grupos existentes al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarParticipantes(); // Cargar participantes inmediatamente
    cargarGrupos(); // Intentar cargar grupos si ya existen
});

function iniciarJuego() {
    const participantesCount = parseInt(document.getElementById('participantes-count').textContent);
    
    if (participantesCount === 0) {
        alert('No hay participantes para iniciar el juego');
        return;
    }
    
    if (confirm(`¿Iniciar juego con ${participantesCount} participante(s)?`)) {
        fetch(`/sala/${SALA_ID}/iniciar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('¡Juego iniciado!');
                // Redirigir a la página de juego
                window.location.href = `/sala/${SALA_ID}/juego`;
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error al iniciar juego:', error);
            alert('Error al iniciar juego. Ver consola para más detalles.');
        });
    }
}

function finalizarJuego() {
    if (confirm('¿Está seguro de que desea finalizar la sala?')) {
        window.location.href = "{{ url_for('mis_cuestionarios') }}";
    }
}

function copiarCodigo() {
    navigator.clipboard.writeText(codigoSala).then(() => {
        alert('Código copiado: ' + codigoSala);
    }).catch(() => {
        alert('Código: ' + codigoSala);
    });
}
</script>
{% endblock %}
