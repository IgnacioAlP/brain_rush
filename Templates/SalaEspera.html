{% extends "BrainRush_Master.html" %}

{% block title %}Sala de Espera - Brain RUSH{% endblock %}

{% block extra_css %}
<style>
.sala-espera-page {
  padding: var(--space-xl) 0;
  min-height: 70vh;
}

.sala-container {
  max-width: 900px;
  margin: 0 auto;
}

.sala-header {
  background: var(--gradient-primary);
  border-radius: var(--radius-xl);
  padding: var(--space-xl);
  text-align: center;
  box-shadow: var(--shadow-lg);
  margin-bottom: var(--space-xxl);
  position: relative;
  overflow: hidden;
}

.sala-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.05); }
}

.sala-header h1 {
  font-family: var(--font-primary);
  font-size: 2.5rem;
  color: white;
  margin-bottom: var(--space-sm);
  position: relative;
  z-index: 1;
}

.sala-header h2 {
  font-size: 1.3rem;
  color: rgba(255, 255, 255, 0.95);
  font-weight: 600;
  margin-bottom: var(--space-lg);
  position: relative;
  z-index: 1;
}

.pin-display {
  background: white;
  color: var(--primary-color);
  font-size: 3rem;
  font-weight: 800;
  letter-spacing: 0.3em;
  padding: var(--space-lg) var(--space-xxl);
  border-radius: var(--radius-lg);
  display: inline-block;
  box-shadow: var(--shadow-md);
  font-family: 'Courier New', monospace;
  position: relative;
  z-index: 1;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--space-sm);
  background: rgba(150, 206, 180, 0.2);
  color: rgb(34, 139, 34);
  padding: var(--space-sm) var(--space-lg);
  border-radius: var(--radius-xl);
  font-weight: 600;
  margin-top: var(--space-lg);
  position: relative;
  z-index: 1;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: rgb(34, 139, 34);
  animation: blink 2s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.info-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-xl);
  padding: var(--space-xl);
  box-shadow: var(--shadow-lg);
  margin-bottom: var(--space-xl);
}

.info-card h3 {
  font-family: var(--font-primary);
  font-size: 1.5rem;
  color: var(--primary-dark);
  margin-bottom: var(--space-lg);
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.instrucciones {
  background: rgba(69, 183, 209, 0.1);
  border-left: 4px solid var(--accent-color);
  border-radius: var(--radius-md);
  padding: var(--space-lg);
  margin-bottom: var(--space-xl);
}

.instrucciones ol {
  margin: 0;
  padding-left: var(--space-xl);
  color: var(--dark-gray);
  line-height: 1.8;
}

.instrucciones li {
  margin-bottom: var(--space-sm);
}

.instrucciones strong {
  color: var(--primary-color);
  font-weight: 700;
}

.participants-count {
  font-size: 1.5rem;
  color: var(--primary-dark);
  margin-bottom: var(--space-lg);
  font-weight: 700;
  text-align: center;
}

.participants-count span {
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 2rem;
}

.participants-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: var(--space-md);
  margin-bottom: var(--space-xl);
}

.participant-card {
  background: var(--gradient-accent);
  border-radius: var(--radius-lg);
  padding: var(--space-lg);
  text-align: center;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.participant-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.participant-card h4 {
  color: white;
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: var(--space-sm);
}

.participant-card .tiempo {
  color: rgba(255, 255, 255, 0.9);
  font-size: 0.85rem;
}

.grupo-badge {
  background: rgba(255, 255, 255, 0.25);
  color: white;
  padding: var(--space-xs) var(--space-md);
  border-radius: var(--radius-md);
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
  margin-top: var(--space-sm);
}

.grupos-section {
  margin-top: var(--space-xl);
  padding-top: var(--space-xl);
  border-top: 2px dashed rgba(0, 0, 0, 0.1);
}

.grupos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-md);
  margin-top: var(--space-lg);
}

.grupo-card-mini {
  background: rgba(150, 206, 180, 0.15);
  border: 2px solid rgba(150, 206, 180, 0.4);
  border-radius: var(--radius-lg);
  padding: var(--space-lg);
  text-align: center;
  transition: all 0.3s ease;
}

.grupo-card-mini:hover {
  background: rgba(150, 206, 180, 0.25);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.grupo-card-mini .nombre {
  font-weight: 700;
  color: rgb(34, 139, 34);
  font-size: 1.1rem;
  margin-bottom: var(--space-xs);
}

.grupo-card-mini .contador {
  font-size: 0.9rem;
  color: var(--dark-gray);
}

.control-section {
  margin-top: var(--space-xxl);
}

.btn-control {
  width: 100%;
  padding: var(--space-lg) var(--space-xl);
  border: none;
  border-radius: var(--radius-lg);
  font-size: 1.2rem;
  font-weight: 700;
  font-family: var(--font-secondary);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: var(--space-md);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-sm);
  box-shadow: var(--shadow-md);
}

.btn-iniciar {
  background: var(--gradient-primary);
  color: white;
}

.btn-iniciar:hover:not(:disabled) {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.btn-iniciar:disabled {
  background: linear-gradient(135deg, #ccc 0%, #aaa 100%);
  cursor: not-allowed;
  opacity: 0.6;
}

.btn-cerrar {
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  color: white;
}

.btn-cerrar:hover {
  background: linear-gradient(135deg, #545b62 0%, #343a40 100%);
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.waiting-message {
  background: rgba(69, 183, 209, 0.15);
  border: 2px solid rgba(69, 183, 209, 0.3);
  border-radius: var(--radius-lg);
  padding: var(--space-xl);
  text-align: center;
  color: var(--accent-color);
  font-size: 1.2rem;
  font-weight: 600;
}

.tip-box {
  background: rgba(255, 234, 167, 0.2);
  border-left: 4px solid var(--warning-color);
  border-radius: var(--radius-md);
  padding: var(--space-lg);
  margin-top: var(--space-xl);
  color: var(--dark-gray);
  line-height: 1.6;
}

.tip-box strong {
  color: #F7931E;
}

.no-participants {
  text-align: center;
  padding: var(--space-xxl);
  color: var(--gray);
}

.no-participants p {
  font-size: 1.1rem;
  margin-bottom: var(--space-sm);
}

@media (max-width: 768px) {
  .sala-header h1 {
    font-size: 2rem;
  }
  
  .pin-display {
    font-size: 2rem;
    padding: var(--space-md) var(--space-lg);
    letter-spacing: 0.2em;
  }
  
  .participants-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  
  .grupos-grid {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container sala-espera-page">
  <div class="sala-container animate-fadeIn">
    
    <!-- Header de la Sala -->
    <div class="sala-header">
      <div class="status-badge">
        <div class="status-dot"></div>
        <span>Sala activa</span>
      </div>
      <h1>üß† Sala de Juego</h1>
      <h2>{{ sala.cuestionario_titulo or 'Cuestionario' }}</h2>
      <div class="pin-display">{{ pin_sala }}</div>
    </div>

    <!-- Instrucciones -->
    <div class="info-card">
      <h3>üì± Instrucciones para estudiantes</h3>
      <div class="instrucciones">
        <ol>
          <li>Abre tu navegador y ve a <strong>{{ request.host_url }}unirse_a_sala</strong></li>
          <li>Ingresa el c√≥digo PIN: <strong>{{ pin_sala }}</strong></li>
          <li>Escribe tu nombre completo</li>
          <li>{% if session.get('usuario_tipo') == 'docente' %}Selecciona tu grupo (si hay grupos){% else %}Espera a que inicie el juego{% endif %}</li>
          <li>¬°A jugar! üéÆ</li>
        </ol>
      </div>
    </div>

    <!-- Participantes -->
    <div class="info-card">
      <h3>üë• Participantes</h3>
      <div class="participants-count">
        Total: <span id="participant-count">0</span>
      </div>
      
      <div id="participants-container">
        <div class="participants-grid" id="participants-list">
          <div class="no-participants">
            <p>‚è≥ Esperando participantes...</p>
            <p style="font-size: 0.9rem;">Comparte el PIN <strong>{{ pin_sala }}</strong> con los estudiantes</p>
          </div>
        </div>
      </div>

      <!-- Secci√≥n de Grupos -->
      <div class="grupos-section" id="grupos-section" style="display: none;">
        <h3 style="font-family: var(--font-primary); font-size: 1.3rem; color: var(--primary-dark); margin-bottom: var(--space-lg); text-align: center;">
          üìä Distribuci√≥n por Grupos
        </h3>
        <div class="grupos-grid" id="grupos-grid">
          <!-- Los grupos se cargar√°n aqu√≠ din√°micamente -->
        </div>
      </div>
    </div>

    <!-- Controles (Solo Docente) -->
    <div class="control-section">
      {% if session.get('usuario_tipo') == 'docente' %}
        <button id="start-game-btn" class="btn-control btn-iniciar" disabled>
          üöÄ Iniciar Juego
        </button>
        <button id="close-room-btn" class="btn-control btn-cerrar">
          ‚ùå Cerrar Sala
        </button>
      {% else %}
        <div class="waiting-message">
          ‚è≥ <strong>Esperando que el profesor inicie el juego...</strong>
        </div>
      {% endif %}
    </div>

    <!-- Tip Box -->
    <div class="tip-box">
      üí° <strong>Tip:</strong> Proyecta esta pantalla para que todos puedan ver el PIN y las instrucciones en tiempo real.
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}

  <script>
    const SALA_ID = {{ sala.id }};
    const ES_DOCENTE = {{ 'true' if session.get('usuario_tipo') == 'docente' else 'false' }};
    let ultimosParticipantes = [];
    let gruposDisponibles = [];
    let intervaloActualizacion = null;

    // Funci√≥n para cargar grupos
    async function cargarGrupos() {
      try {
        const response = await fetch(`/api/sala/${SALA_ID}/grupos`);
        const data = await response.json();
        
        if (data.success && data.grupos && data.grupos.length > 0) {
          gruposDisponibles = data.grupos;
          mostrarGrupos();
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error cargando grupos:', error);
        return false;
      }
    }

    // Funci√≥n para mostrar grupos
    function mostrarGrupos() {
      const gruposSection = document.getElementById('grupos-section');
      const gruposGrid = document.getElementById('grupos-grid');
      
      if (gruposDisponibles.length > 0) {
        gruposSection.style.display = 'block';
        gruposGrid.innerHTML = '';
        
        gruposDisponibles.forEach(grupo => {
          const card = document.createElement('div');
          card.className = 'grupo-card-mini';
          card.innerHTML = `
            <div class="nombre">${grupo.nombre_grupo}</div>
            <div class="contador" id="grupo-${grupo.id_grupo}-count">0 estudiantes</div>
          `;
          gruposGrid.appendChild(card);
        });
      } else {
        gruposSection.style.display = 'none';
      }
    }

    // Funci√≥n para actualizar contadores de grupos
    function actualizarContadoresGrupos(participantes) {
      if (gruposDisponibles.length === 0) return;
      
      // Contar participantes por grupo
      const gruposCuentas = {};
      gruposDisponibles.forEach(g => {
        gruposCuentas[g.id_grupo] = 0;
      });
      
      participantes.forEach(p => {
        if (p.id_grupo && gruposCuentas[p.id_grupo] !== undefined) {
          gruposCuentas[p.id_grupo]++;
        }
      });
      
      // Actualizar visualizaci√≥n
      Object.keys(gruposCuentas).forEach(grupoId => {
        const countEl = document.getElementById(`grupo-${grupoId}-count`);
        if (countEl) {
          const count = gruposCuentas[grupoId];
          countEl.textContent = `${count} estudiante${count !== 1 ? 's' : ''}`;
        }
      });
    }

    // Funci√≥n para actualizar la lista de participantes
    async function actualizarParticipantes() {
      try {
        const response = await fetch(`/api/sala/${SALA_ID}/participantes`);
        const data = await response.json();
        
        if (data.success) {
          const participantes = data.participantes || [];
          
          // VERIFICAR ESTADO DE LA SALA
          console.log('üìä Estado actual de la sala:', data.sala ? data.sala.estado : 'no disponible');
          
          // Si el estado cambi√≥ a 'en_juego', redirigir autom√°ticamente
          if (data.sala && data.sala.estado === 'en_juego') {
            console.log('üéÆ ¬°EL JUEGO HA INICIADO! Redirigiendo al juego...');
            alert('¬°El juego ha comenzado! Redirigiendo...');
            detenerActualizaciones();
            window.location.href = `/sala/${SALA_ID}/juego`;
            return;
          }
          
          // Actualizar contador
          document.getElementById('participant-count').textContent = participantes.length;
          
          // Actualizar lista con nuevo dise√±o
          const listElement = document.getElementById('participants-list');
          if (participantes.length === 0) {
            listElement.innerHTML = `
              <div class="no-participants">
                <p>‚è≥ Esperando participantes...</p>
                <p style="font-size: 0.9rem;">Comparte el PIN <strong>{{ pin_sala }}</strong> con los estudiantes</p>
              </div>
            `;
          } else {
            listElement.innerHTML = participantes.map(p => {
              const grupoBadge = p.nombre_grupo ? 
                `<div class="grupo-badge">üë• ${p.nombre_grupo}</div>` : '';
              return `
                <div class="participant-card">
                  <h4>${p.nombre_participante || p.nombre}</h4>
                  <div class="tiempo">${new Date(p.fecha_union).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}</div>
                  ${grupoBadge}
                </div>
              `;
            }).join('');
          }
          
          // Actualizar contadores de grupos
          actualizarContadoresGrupos(participantes);
          
          // Habilitar bot√≥n de inicio si hay al menos 1 participante (solo para docentes)
          if (ES_DOCENTE) {
            const startButton = document.getElementById('start-game-btn');
            if (startButton) {
              startButton.disabled = participantes.length === 0;
            }
          }
          
          // Notificar si hay nuevos participantes
          if (participantes.length > ultimosParticipantes.length) {
            const nuevos = participantes.slice(ultimosParticipantes.length);
            nuevos.forEach(p => {
              console.log(`‚úÖ Nuevo participante: ${p.nombre_participante || p.nombre}`);
            });
          }
          
          ultimosParticipantes = participantes;
        }
      } catch (error) {
        console.error('Error al actualizar participantes:', error);
      }
    }

    // Funci√≥n para verificar el estado de la sala
    async function verificarEstadoSala() {
      try {
        const response = await fetch(`/api/sala/${SALA_ID}/estado`);
        const data = await response.json();
        
        if (data.success) {
          const estado = data.estado;
          
          // Si el estado cambi√≥ a 'en_curso', redirigir al juego
          if (estado === 'en_curso') {
            console.log('üéÆ El juego ha comenzado, redirigiendo...');
            detenerActualizaciones();
            window.location.href = `/juego/{{ sala.pin_sala }}/jugar`;
          }
          
          // Si la sala se cerr√≥, redirigir
          if (estado === 'finalizada') {
            console.log('‚ùå La sala ha sido cerrada');
            detenerActualizaciones();
            alert('La sala ha sido cerrada por el docente');
            window.location.href = '/dashboard-docente';
          }
        }
      } catch (error) {
        console.error('Error al verificar estado de sala:', error);
      }
    }

    // Iniciar actualizaciones autom√°ticas
    function iniciarActualizaciones() {
      // Primera actualizaci√≥n inmediata
      cargarGrupos(); // Cargar grupos si existen
      actualizarParticipantes();
      verificarEstadoSala();
      
      // Actualizar cada 2 segundos
      intervaloActualizacion = setInterval(() => {
        actualizarParticipantes();
        verificarEstadoSala();
      }, 2000);
      
      console.log('‚úÖ Sistema de actualizaciones en tiempo real iniciado');
    }

    // Detener actualizaciones
    function detenerActualizaciones() {
      if (intervaloActualizacion) {
        clearInterval(intervaloActualizacion);
        intervaloActualizacion = null;
        console.log('‚èπÔ∏è Actualizaciones detenidas');
      }
    }

    // Event listener para iniciar juego (solo docente)
    const startGameBtn = document.getElementById('start-game-btn');
    if (startGameBtn && ES_DOCENTE) {
      startGameBtn.addEventListener('click', async function() {
        const participantesCount = ultimosParticipantes.length;
        
        if (participantesCount === 0) {
          alert('‚ö†Ô∏è Necesitas al menos un participante para iniciar el juego');
          return;
        }
        
        if (confirm(`üéÆ ¬øIniciar juego con ${participantesCount} participante(s)?`)) {
          try {
            detenerActualizaciones();
            
            // Llamar al endpoint para iniciar el juego
            const response = await fetch(`/sala/${SALA_ID}/iniciar`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            const data = await response.json();
            
            if (data.success) {
              window.location.href = `/sala/${SALA_ID}/monitorear`;
            } else {
              alert('Error al iniciar el juego: ' + data.error);
              iniciarActualizaciones();
            }
          } catch (error) {
            console.error('Error al iniciar juego:', error);
            alert('Error al iniciar el juego. Intenta nuevamente.');
            iniciarActualizaciones();
          }
        }
      });
    }

    // Event listener para cerrar sala (solo docente)
    const closeRoomBtn = document.getElementById('close-room-btn');
    if (closeRoomBtn && ES_DOCENTE) {
      closeRoomBtn.addEventListener('click', async function() {
        if (confirm('‚ùå ¬øEst√°s seguro de que quieres cerrar la sala? Todos los participantes ser√°n desconectados.')) {
          try {
            detenerActualizaciones();
            
            const response = await fetch(`/sala/${SALA_ID}/cerrar`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            const data = await response.json();
            
            if (data.success) {
              window.location.href = '/mis-cuestionarios';
            } else {
              alert('Error al cerrar la sala: ' + data.error);
            }
          } catch (error) {
            console.error('Error al cerrar sala:', error);
            alert('Error al cerrar la sala. Intenta nuevamente.');
          }
        }
      });
    }

    // Iniciar cuando la p√°gina cargue
    // Iniciar cuando la p√°gina cargue
    window.addEventListener('DOMContentLoaded', iniciarActualizaciones);

    // Detener actualizaciones cuando se cierre la p√°gina
    window.addEventListener('beforeunload', detenerActualizaciones);
  </script>
{% endblock %}