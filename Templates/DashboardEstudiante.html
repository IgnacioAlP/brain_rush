{% extends "BrainRush_Master.html" %}

{% block title %}Brain RUSH - Dashboard Estudiante{% endblock %}

{% block extra_css %}
<style>
.student-dashboard {
    padding: var(--space-xl) 0;
}

.welcome-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-xl);
    padding: var(--space-xxl);
    margin-bottom: var(--space-xxl);
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
}

.welcome-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-secondary);
}

.welcome-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
}

.welcome-text h1 {
    font-family: var(--font-primary);
    font-size: 2.5rem;
    background: var(--gradient-secondary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
}

.welcome-text p {
    color: var(--gray);
    font-size: 1.1rem;
    font-weight: 600;
}

.level-badge {
    background: var(--gradient-accent);
    color: white;
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-lg);
    font-weight: 700;
    font-size: 1.1rem;
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.progress-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: var(--space-lg);
    align-items: center;
}

.progress-info h3 {
    color: var(--dark);
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: var(--space-sm);
}

.progress-bar {
    width: 100%;
    height: 12px;
    background: rgba(0,0,0,0.1);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin-bottom: var(--space-sm);
}

.progress-fill {
    height: 100%;
    background: var(--gradient-secondary);
    border-radius: var(--radius-lg);
    width: 65%;
    transition: width 1s ease;
}

.progress-text {
    color: var(--gray);
    font-size: 0.9rem;
    font-weight: 600;
}

.xp-display {
    text-align: center;
    background: rgba(78, 205, 196, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
}

.xp-number {
    font-family: var(--font-primary);
    font-size: 2rem;
    color: var(--secondary-color);
    display: block;
}

.xp-label {
    color: var(--gray);
    font-size: 0.9rem;
    font-weight: 600;
}

.action-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xxl);
}

.action-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    box-shadow: var(--shadow-md);
    transition: var(--transition-smooth);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
}

.action-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-xl);
}

.action-card.primary::before {
    background: var(--gradient-primary);
}

.action-card.secondary::before {
    background: var(--gradient-secondary);
}

.action-card.accent::before {
    background: var(--gradient-accent);
}

.action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.card-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--space-lg);
    font-size: 2rem;
    color: white;
}

.card-icon.primary {
    background: var(--gradient-primary);
}

.card-icon.secondary {
    background: var(--gradient-secondary);
}

.card-icon.accent {
    background: var(--gradient-accent);
}

.card-title {
    font-family: var(--font-primary);
    font-size: 1.5rem;
    color: var(--dark);
    margin-bottom: var(--space-sm);
}

.card-description {
    color: var(--gray);
    line-height: 1.6;
    margin-bottom: var(--space-lg);
}

.card-action {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    color: var(--primary-color);
    font-weight: 600;
    font-size: 0.9rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xxl);
}

.stat-item {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    text-align: center;
    box-shadow: var(--shadow-md);
    transition: var(--transition-smooth);
}

.stat-item:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    width: 50px;
    height: 50px;
    background: var(--gradient-accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-md);
    color: white;
    font-size: 1.5rem;
}

.stat-number {
    font-family: var(--font-primary);
    font-size: 2rem;
    color: var(--accent-color);
    margin-bottom: var(--space-sm);
}

.stat-label {
    color: var(--gray);
    font-weight: 600;
    font-size: 0.9rem;
}

.recent-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    box-shadow: var(--shadow-md);
}

.recent-header {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Corregido 'between' a 'space-between' */
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 2px solid rgba(0,0,0,0.1);
}

.recent-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    color: var(--dark);
    font-size: 1.3rem;
    font-weight: 700;
}

.recent-games {
    display: grid;
    gap: var(--space-md);
}

.game-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    transition: var(--transition-fast);
    cursor: pointer;
}

.game-item:hover {
    background: rgba(0,0,0,0.05);
}

.game-icon {
    width: 40px;
    height: 40px;
    background: var(--gradient-secondary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.game-info {
    flex: 1;
}

.game-name {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: var(--space-xs);
}

.game-details {
    color: var(--gray);
    font-size: 0.85rem;
}

.game-score {
    text-align: right;
    font-weight: 700;
    color: var(--secondary-color);
    font-size: 1.1rem;
}

/* === INICIO DE ESTILOS RESPONSIVOS === */
@media (max-width: 768px) {
    .student-dashboard {
        /* AÃ±ade padding lateral */
        padding: var(--space-xl) var(--space-lg);
    }
    
    .welcome-section {
        padding: var(--space-xl);
    }
    
    .welcome-header {
        flex-direction: column;
        text-align: center;
        gap: var(--space-lg);
    }
    
    .progress-section {
        grid-template-columns: 1fr;
    }
    
    .action-cards {
        /* minmax(300px, 1fr) ya se encarga de esto, pero 1fr lo fuerza */
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        /* Pasa a 2 columnas */
        grid-template-columns: repeat(2, 1fr);
    }

    /* Ajusta el padding de las secciones */
    .action-card, .stat-item, .recent-section {
        padding: var(--space-lg);
    }
}

@media (max-width: 480px) {
    .student-dashboard {
        padding: var(--space-lg) var(--space-sm);
    }

    .welcome-section {
        padding: var(--space-lg);
    }

    .welcome-text h1 {
        font-size: 2rem;
    }
    
    .stats-grid {
        /* Pasa a 1 columna */
        grid-template-columns: 1fr;
    }

    .game-item {
        /* Permite que los items se reorganicen */
        flex-wrap: wrap;
    }

    .game-info {
        /* Ocupa todo el ancho disponible */
        flex-basis: 100%;
        margin-bottom: var(--space-sm);
    }

    .game-score {
        /* Mueve la puntuaciÃ³n al final */
        flex-basis: 100%;
        text-align: right;
    }

    .action-card, .stat-item, .recent-section {
        padding: var(--space-md);
    }
}
/* === FIN DE ESTILOS RESPONSIVOS === */
</style>
{% endblock %}

{% block content %}
<div class="student-dashboard">
    <div class="welcome-section animate-fadeIn">
        <div class="welcome-header">
            <div class="welcome-text">
                <h1>Â¡Hola, {{ session.usuario_nombre or 'Estudiante' }}!</h1>
                <p>Â¿Listo para tu prÃ³xima aventura de aprendizaje?</p>
            </div>
        </div>
    </div>

    <!-- Widget de XP -->
    <div class="xp-widget animate-fadeIn" style="animation-delay: 0.05s; margin-bottom: var(--space-xxl);">
        <div style="background: white; border-radius: var(--radius-xl); padding: var(--space-xl); box-shadow: var(--shadow-lg); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #FFD700, #FFA500);"></div>
            
            <div style="display: grid; grid-template-columns: auto 1fr auto auto; gap: var(--space-xl); align-items: center;">
                <!-- Avatar con nivel -->
                <div style="text-align: center;">
                    <div id="xpAvatar" style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: flex; align-items: center; justify-content: center; font-size: 36px; border: 4px solid rgba(255, 215, 0, 0.3); margin-bottom: var(--space-sm);">
                        ðŸ‘¤
                    </div>
                    <div style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px;">
                        Nv. <span id="xpNivel">1</span>
                    </div>
                </div>

                <!-- Barra de progreso -->
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-sm);">
                        <span style="font-weight: bold; color: var(--dark);">Progreso al siguiente nivel</span>
                        <span style="color: var(--gray); font-weight: 600;" id="xpTexto">0 / 0 XP</span>
                    </div>
                    <div style="width: 100%; height: 25px; background: #e0e0e0; border-radius: 15px; overflow: hidden; position: relative;">
                        <div id="xpBarraProgreso" style="height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); border-radius: 15px; width: 0%; transition: width 1s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                            0%
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div style="text-align: center; padding: 0 var(--space-lg); border-left: 2px solid #e0e0e0;">
                    <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="xpTotal">0</div>
                    <div style="color: var(--gray); font-size: 14px; font-weight: 600;">XP Total</div>
                </div>

                <!-- Botones de acciÃ³n -->
                <div style="display: flex; gap: var(--space-sm);">
                    <a href="/ranking-xp" class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: var(--space-sm); transition: transform 0.3s; white-space: nowrap;">
                        <i class="fas fa-trophy"></i> Ranking
                    </a>
                    <a href="/mis-insignias" class="btn" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; padding: 12px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: var(--space-sm); transition: transform 0.3s; white-space: nowrap;">
                        <i class="fas fa-medal"></i> <span id="insigniasCount">0</span> Insignias
                    </a>
                    <a href="/tienda-insignias" class="btn" style="background: linear-gradient(135deg, #FF6B35, #F7931E); color: white; padding: 12px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: var(--space-sm); transition: transform 0.3s; white-space: nowrap;">
                        <i class="fas fa-store"></i> Tienda
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="action-cards">
        <a href="{{ url_for('unirse_a_sala') }}" class="action-card primary animate-fadeIn" style="animation-delay: 0.1s;">
            <div class="card-icon primary">
                <i class="fas fa-gamepad"></i>
            </div>
            <h3 class="card-title">Unirse a Juego</h3>
            <p class="card-description">
                Â¿Tienes un cÃ³digo de sala? Â¡Ãšnete y demuestra tus conocimientos en tiempo real!
            </p>
            <div class="card-action">
                <span>Comenzar ahora</span>
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>

        <a href="{{ url_for('historial_estudiante') }}" class="action-card secondary animate-fadeIn" style="animation-delay: 0.2s;">
            <div class="card-icon secondary">
                <i class="fas fa-history"></i>
            </div>
            <h3 class="card-title">Mi Historial</h3>
            <p class="card-description">
                Revisa todas tus partidas anteriores, puntuaciones y tu evoluciÃ³n acadÃ©mica.
            </p>
            <div class="card-action">
                <span>Ver historial</span>
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>

        <a href="{{ url_for('ranking_global') }}" class="action-card accent animate-fadeIn" style="animation-delay: 0.3s;">
            <div class="card-icon accent">
                <i class="fas fa-trophy"></i>
            </div>
            <h3 class="card-title">Ranking Global</h3>
            <p class="card-description">
                Â¡Compite con estudiantes de todo el mundo y escala hasta la cima!
            </p>
            <div class="card-action">
                <span>Ver ranking</span>
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
    </div>

    <div class="recent-section animate-fadeIn" style="animation-delay: 0.4s; margin-bottom: var(--space-xxl);">
        <div class="recent-header">
            <h2 class="recent-title">
                <i class="fas fa-list-alt"></i>
                Cuestionarios Disponibles
            </h2>
        </div>

        {% if cuestionarios and cuestionarios|length > 0 %}
        <div class="cuestionarios-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--space-lg); margin-top: var(--space-lg);">
            {% for cuestionario in cuestionarios %}
            <div class="cuestionario-card" style="background: rgba(255,255,255,0.95); border-radius: var(--radius-lg); padding: var(--space-lg); box-shadow: var(--shadow-md); transition: var(--transition-smooth); border-left: 4px solid var(--primary-color);">
                <h4 style="color: var(--dark); font-size: 1.2rem; margin-bottom: var(--space-sm); font-weight: 700;">
                    {{ cuestionario.titulo }}
                </h4>
                <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: var(--space-md); line-height: 1.5;">
                    {{ cuestionario.descripcion|truncate(100) }}
                </p>
                <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md); font-size: 0.85rem; color: var(--gray);">
                    <span>
                        <i class="fas fa-user"></i> 
                        {{ cuestionario.nombre_docente }} {{ cuestionario.apellidos_docente }}
                    </span>
                    <span>
                        <i class="fas fa-question-circle"></i> 
                        {{ cuestionario.total_preguntas }} preguntas
                    </span>
                </div>
                <div style="display: flex; gap: var(--space-sm);">
                    <button onclick="jugarIndividual({{ cuestionario.id_cuestionario }})" class="btn-primary btn-jugar-individual" style="flex: 1; text-align: center; padding: var(--space-sm) var(--space-md); background: var(--gradient-primary); color: white; border-radius: var(--radius-md); border: none; font-weight: 600; transition: var(--transition-fast); cursor: pointer;">
                        <i class="fas fa-play"></i> Jugar
                    </button>
                    <a href="{{ url_for('ver_cuestionario', cuestionario_id=cuestionario.id_cuestionario) }}" class="btn-secondary" style="padding: var(--space-sm) var(--space-md); background: rgba(0,0,0,0.1); color: var(--dark); border-radius: var(--radius-md); text-decoration: none; font-weight: 600; transition: var(--transition-fast);">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: var(--space-xxl); color: rgba(0,0,0,0.4);">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: var(--space-md); opacity: 0.3;"></i>
            <p style="font-size: 1.1rem;">No hay cuestionarios publicados disponibles en este momento.</p>
        </div>
        {% endif %}
    </div>

    <div class="stats-grid">
        <div class="stat-item animate-fadeIn" style="animation-delay: 0.4s;">
            <div class="stat-icon">
                <i class="fas fa-gamepad"></i>
            </div>
            <div class="stat-number">{{ estadisticas.total_participaciones or 0 }}</div>
            <div class="stat-label">Partidas Jugadas</div>
        </div>

        <div class="stat-item animate-fadeIn" style="animation-delay: 0.5s;">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-number">{{ "%.0f"|format(estadisticas.promedio_puntaje or 0) }}</div>
            <div class="stat-label">Promedio Puntos</div>
        </div>

        <div class="stat-item animate-fadeIn" style="animation-delay: 0.6s;">
            <div class="stat-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-number">{{ estadisticas.mejor_posicion or 'N/A' }}</div>
            <div class="stat-label">Mejor PosiciÃ³n</div>
        </div>

        <div class="stat-item animate-fadeIn" style="animation-delay: 0.7s;">
            <div class="stat-icon">
                <i class="fas fa-gift"></i>
            </div>
            <div class="stat-number">{{ estadisticas.recompensas_obtenidas or 0 }}</div>
            <div class="stat-label">Recompensas Obtenidas</div>
        </div>
    </div>

    <div class="recent-section animate-fadeIn" style="animation-delay: 0.8s;">
        <div class="recent-header">
            <h2 class="recent-title">
                <i class="fas fa-clock"></i>
                Partidas Recientes
            </h2>
        </div>

        {% if partidas_recientes and partidas_recientes|length > 0 %}
        <div class="recent-games">
            {% for partida in partidas_recientes %}
            <div class="game-item">
                <div class="game-icon">
                    <i class="fas fa-{% if partida.es_individual %}user{% else %}users{% endif %}"></i>
                </div>
                <div class="game-info">
                    <div class="game-name">{{ partida.cuestionario_titulo }}</div>
                    <div class="game-details">
                        {{ partida.tipo }} â€¢ {{ partida.total_preguntas }} preguntas â€¢ 
                        {% if partida.fecha %}
                            {% set delta = (now() - partida.fecha).total_seconds() %}
                            {% if delta < 3600 %}
                                Hace {{ (delta / 60)|int }} min
                            {% elif delta < 86400 %}
                                Hace {{ (delta / 3600)|int }} horas
                            {% elif delta < 172800 %}
                                Ayer
                            {% else %}
                                Hace {{ (delta / 86400)|int }} dÃ­as
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                <div class="game-score">{{ partida.puntaje or 0 }} pts</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: var(--space-xxl); color: rgba(0,0,0,0.4);">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: var(--space-md); opacity: 0.3;"></i>
            <p style="font-size: 1.1rem;">AÃºn no has jugado ninguna partida.</p>
            <p style="font-size: 0.9rem; color: var(--gray);">Â¡Ãšnete a una sala o juega un cuestionario individual para comenzar!</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
async function jugarIndividual(cuestionarioId) {
    console.log('ðŸŽ® Iniciando juego individual para cuestionario:', cuestionarioId);
    
    // Mostrar loading
    Swal.fire({
        title: 'Preparando tu juego...',
        html: 'Creando sala automÃ¡tica',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    try {
        const response = await fetch(`/jugar-individual/${cuestionarioId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Mostrar mensaje de Ã©xito
            await Swal.fire({
                icon: 'success',
                title: 'Â¡Listo para jugar!',
                text: `Sala creada con PIN: ${data.pin_sala}`,
                showConfirmButton: true,
                timer: 2000,
                timerProgressBar: true
            });
            
            // Redirigir al juego
            window.location.href = data.redirect;
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error || 'No se pudo crear la sala de juego',
                confirmButtonColor: '#4ECDC4'
            });
        }
    } catch (error) {
        console.error('âŒ Error al crear sala individual:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error de conexiÃ³n',
            text: 'No se pudo conectar con el servidor. Por favor intenta nuevamente.',
            confirmButtonColor: '#4ECDC4'
        });
    }
}

// Animaciones de entrada
document.addEventListener('DOMContentLoaded', function() {
    // AnimaciÃ³n de nÃºmeros
    const statNumbers = document.querySelectorAll('.stat-number');
    statNumbers.forEach(number => {
        const finalValue = parseInt(number.textContent);
        if (finalValue > 0) {
            animateNumber(number, 0, finalValue, 1500);
        }
    });
    
    function animateNumber(element, start, end, duration) {
        const startTime = performance.now();
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const current = Math.floor(start + (end - start) * easeOutCubic(progress));
            element.textContent = current;
            
            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }
        
        requestAnimationFrame(update);
    }
    
    function easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
    }
    
    // Efecto hover en cards de cuestionarios
    const cuestionarioCards = document.querySelectorAll('.cuestionario-card');
    cuestionarioCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px)';
            this.style.boxShadow = 'var(--shadow-xl)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'var(--shadow-md)';
        });
    });

    // Cargar datos de XP del estudiante
    cargarDatosXP();
});

// FunciÃ³n para cargar y mostrar datos de XP
async function cargarDatosXP() {
    const usuarioId = "{{ session.get('usuario_id') }}";
    if (!usuarioId || usuarioId === '') return;

    try {
        const response = await fetch(`/api/perfil-xp/${usuarioId}`);
        const data = await response.json();
        
        console.log('Datos XP recibidos:', data);
        
        if (data.success && data.perfil) {
            const perfil = data.perfil;
            
            // Actualizar avatar (primera letra del nombre)
            const inicial = perfil.nombre_completo ? perfil.nombre_completo.charAt(0).toUpperCase() : 'ðŸ‘¤';
            document.getElementById('xpAvatar').textContent = inicial;
            
            // Actualizar nivel (con valor por defecto)
            document.getElementById('xpNivel').textContent = perfil.nivel_actual || 1;
            
            // Actualizar XP total (con valor por defecto)
            document.getElementById('xpTotal').textContent = formatearNumeroXP(perfil.xp_total_acumulado || 0);
            
            // Actualizar texto de progreso
            document.getElementById('xpTexto').textContent = 
                `${formatearNumeroXP(perfil.xp_actual || 0)} / ${formatearNumeroXP(perfil.xp_siguiente_nivel || 100)} XP`;
            
            // Animar barra de progreso
            const porcentaje = perfil.porcentaje_nivel || 0;
            const barra = document.getElementById('xpBarraProgreso');
            setTimeout(() => {
                barra.style.width = `${porcentaje}%`;
                barra.textContent = `${porcentaje}%`;
            }, 500);
            
            // Actualizar contador de insignias
            document.getElementById('insigniasCount').textContent = perfil.insignias_desbloqueadas || 0;
        } else {
            console.log('No se pudieron cargar los datos de XP');
            // Valores por defecto si no hay datos
            document.getElementById('xpNivel').textContent = '1';
            document.getElementById('xpTotal').textContent = '0';
            document.getElementById('xpTexto').textContent = '0 / 100 XP';
            document.getElementById('insigniasCount').textContent = '0';
        }
    } catch (error) {
        console.error('Error al cargar datos de XP:', error);
        // Valores por defecto en caso de error
        document.getElementById('xpNivel').textContent = '1';
        document.getElementById('xpTotal').textContent = '0';
        document.getElementById('xpTexto').textContent = '0 / 100 XP';
        document.getElementById('insigniasCount').textContent = '0';
    }
}

function formatearNumeroXP(num) {
    // Validar que num sea un nÃºmero vÃ¡lido
    if (num === null || num === undefined || isNaN(num)) {
        return '0';
    }
    
    const numero = Number(num);
    
    if (numero >= 1000000) {
        return (numero / 1000000).toFixed(1) + 'M';
    } else if (numero >= 1000) {
        return (numero / 1000).toFixed(1) + 'K';
    }
    return numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
</script>
{% endblock %}