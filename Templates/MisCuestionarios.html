{% extends "BrainRush_Master.html" %}

{% block title %}Brain RUSH - Mis Cuestionarios{% endblock %}

{% block extra_css %}
<style>
.quizzes-page {
    padding: var(--space-xl) 0;
}

.page-header {
    text-align: center;
    margin-bottom: var(--space-xxl);
}

.page-title {
    font-family: var(--font-primary);
    font-size: 2.5rem;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
}

.page-subtitle {
    color: rgba(255,255,255,0.9);
    font-size: 1.1rem;
    font-weight: 600;
}

.quizzes-container {
    max-width: 1200px;
    margin: 0 auto;
}

.quiz-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-md);
    transition: var(--transition-smooth);
}

.quiz-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
}

.quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-lg);
}

.quiz-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: var(--space-sm);
}

.quiz-description {
    color: var(--gray);
    margin-bottom: var(--space-md);
}

.quiz-meta {
    display: flex;
    gap: var(--space-lg);
    align-items: center;
    margin-bottom: var(--space-lg);
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    color: var(--gray);
    font-size: 0.9rem;
}

.quiz-status {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-borrador {
    background: rgba(255, 193, 7, 0.2);
    color: #856404;
}

.status-publicado {
    background: rgba(40, 167, 69, 0.2);
    color: #155724;
}

.quiz-actions {
    display: flex;
    gap: var(--space-sm);
}

.action-btn {
    padding: var(--space-sm) var(--space-md);
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-smooth);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
}

.btn-secondary {
    background: var(--gradient-secondary);
    color: white;
}

.btn-outline {
    background: transparent;
    color: var(--dark);
    border: 2px solid rgba(0,0,0,0.2);
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.empty-state {
    text-align: center;
    padding: var(--space-xxl);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-xl);
}

.empty-icon {
    font-size: 3rem;
    color: var(--gray);
    margin-bottom: var(--space-lg);
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: var(--space-md);
}

.empty-text {
    color: var(--gray);
    margin-bottom: var(--space-xl);
}

.create-btn {
    background: var(--gradient-primary);
    color: white;
    padding: var(--space-lg) var(--space-xxl);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1.1rem;
    font-weight: 700;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    transition: var(--transition-smooth);
}

.create-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    text-decoration: none;
    color: white;
}

/* Estilos para botones de acci√≥n */
.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
}

.btn-success:hover {
    background: linear-gradient(135deg, #218838, #1ea085);
    transform: translateY(-2px);
}

.btn-warning {
    background: linear-gradient(135deg, #ffc107, #ff8c00);
    color: #212529;
    border: none;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #e0a800, #e6780a);
    transform: translateY(-2px);
}

/* Mejorar estilos del status badge existente */
.quiz-status {
    padding: 0.4rem 1rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 2px solid transparent;
}

.status-borrador {
    background: rgba(255, 193, 7, 0.1);
    color: #ff8c00;
    border-color: rgba(255, 193, 7, 0.3);
}

.status-publicado {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
    border-color: rgba(40, 167, 69, 0.3);
}

.status-programado {
    background: rgba(23, 162, 184, 0.1);
    color: #17a2b8;
    border-color: rgba(23, 162, 184, 0.3);
}

.status-finalizado {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
    border-color: rgba(108, 117, 125, 0.3);
}

/* Modal de historial de salas */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 2rem;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: var(--radius-xl);
    max-width: 900px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: 2rem;
    border-bottom: 2px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--gradient-hero);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    margin: 0;
}

.modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    transition: all 0.3s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.modal-body {
    padding: 2rem;
}

.salas-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.sala-item {
    background: #f8fafc;
    border-radius: var(--radius-md);
    padding: 1.5rem;
    border-left: 4px solid var(--gradient-hero);
    transition: all 0.3s;
}

.sala-item:hover {
    background: #f1f5f9;
    transform: translateX(5px);
}

.sala-header-info {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.sala-info {
    flex: 1;
}

.sala-pin {
    font-size: 1.2rem;
    font-weight: 700;
    color: #4ECDC4;
    margin-bottom: 0.5rem;
}

.sala-meta {
    display: flex;
    gap: 1.5rem;
    color: #64748b;
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

.sala-meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sala-estado {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.estado-esperando {
    background: #fff3cd;
    color: #856404;
}

.estado-en_curso {
    background: #d1ecf1;
    color: #0c5460;
}

.estado-finalizada {
    background: #d4edda;
    color: #155724;
}

.sala-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.sala-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-view-results {
    background: linear-gradient(135deg, #4ECDC4, #44A08D);
    color: white;
}

.btn-export-dropdown {
    position: relative;
}

.export-options {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 0;
    background: white;
    border-radius: var(--radius-md);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    min-width: 200px;
    margin-bottom: 0.5rem;
    z-index: 10;
}

.export-options.active {
    display: block;
}

.export-option {
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.export-option:hover {
    background: #f1f5f9;
}

.export-option:first-child {
    border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.export-option:last-child {
    border-radius: 0 0 var(--radius-md) var(--radius-md);
}

.empty-salas {
    text-align: center;
    padding: 3rem 1rem;
    color: #64748b;
}

.empty-salas i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
/* Bot√≥n Gestionar Recompensas */
.btn-recompensas {
    background: linear-gradient(135deg, #ffb347, #ffcc33);
    color: rgb(0, 0, 0) !important;
    border: none;
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-smooth);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    box-shadow: var(--shadow-sm);
}

.btn-recompensas:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    color: white;
    text-decoration: none;
}


/* --- INICIO BLOQUE RESPONSIVO --- */

/* Estilos para Tablet (Tu bloque original) */
@media (max-width: 768px) {
    .quiz-header {
        flex-direction: column;
        gap: var(--space-md);
    }

    .quiz-meta {
        flex-wrap: wrap;
        gap: var(--space-md);
    }

    .quiz-actions {
        /* Se ajusta a wrap para que los botones fluyan */
        flex-wrap: wrap;
        justify-content: flex-start; /* Alinea al inicio */
    }
}

/* Estilos para Celular (Nuevo bloque) */
@media (max-width: 480px) {
    /* --- Ajustes Generales de la P√°gina --- */
    .page-title {
        font-size: 2rem; /* Reducir un poco el t√≠tulo principal */
    }

    .page-subtitle {
        font-size: 1rem;
    }

    /* --- Ajustes de la Tarjeta de Cuestionario --- */
    .quiz-card {
        padding: var(--space-lg); /* Menos padding en la tarjeta */
    }

    .quiz-title {
        font-size: 1.25rem; /* T√≠tulo de tarjeta m√°s peque√±o */
    }

    /* * ¬°Esto es lo m√°s importante!
     * Apila los botones de acci√≥n verticalmente.
     */
    .quiz-actions {
        flex-direction: column; /* Apilar botones */
        align-items: stretch; /* Estirar botones al 100% del ancho */
        gap: var(--space-md); /* M√°s espacio vertical entre botones */
    }

    .action-btn {
        justify-content: center; /* Centrar √≠cono y texto */
    }

    /* --- Ajustes del Modal --- */
    .modal-overlay {
        padding: 0.5rem; /* Menos padding alrededor del modal */
    }

    .modal-content {
        max-height: 95vh; /* Permitir que ocupe casi toda la altura */
    }

    .modal-header,
    .modal-body {
        padding: 1.5rem 1rem; /* Menos padding dentro del modal */
    }

    .modal-title {
        font-size: 1.2rem;
    }

    /* --- Ajustes de los Items de Sala (en el modal) --- */
    .sala-item {
        padding: 1rem; /* Menos padding */
    }

    /* Apila la info de la sala y el badge de estado */
    .sala-header-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    /* Apila los meta-items (fecha, participantes, modo) */
    .sala-meta {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
    }

    /* Apila los botones de la sala (Ver Resultados, Exportar) */
    .sala-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
    }

    .sala-btn {
        justify-content: center; /* Centrar texto/√≠cono */
    }

    /* --- Ajustes del Estado Vac√≠o --- */
    .empty-state {
        padding: var(--space-xl) var(--space-lg); /* Menos padding */
    }

    .empty-title {
        font-size: 1.25rem;
    }

    .create-btn {
        font-size: 1rem;
        padding: var(--space-md) var(--space-lg);
    }
}

</style>
{% endblock %}

{% block content %}
<div class="quizzes-page">
    <div class="page-header">
        <h1 class="page-title">Mis Cuestionarios</h1>
        <p class="page-subtitle">Gestiona y administra todos tus cuestionarios</p>
    </div>

    <div class="quizzes-container">
        {% if cuestionarios and cuestionarios|length > 0 %}
            {% for cuestionario in cuestionarios %}
            <div class="quiz-card animate-fadeIn" style="animation-delay: {{ loop.index0 * 0.1 }}s;">
                <div class="quiz-header">
                    <div>
                        <h3 class="quiz-title">{{ cuestionario.titulo }}</h3>
                        {% if cuestionario.descripcion %}
                        <p class="quiz-description">{{ cuestionario.descripcion }}</p>
                        {% endif %}

                        <div class="quiz-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>{{ cuestionario.fecha_creacion.strftime('%d/%m/%Y') if cuestionario.fecha_creacion else 'N/A' }}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-list-ol"></i>
                                <span>{{ cuestionario.num_preguntas or 0 }} preguntas</span>
                            </div>
                            <div class="quiz-status status-{{ cuestionario.estado }}">
                                {{ cuestionario.estado.title() }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="quiz-actions">
                    <a href="{{ url_for('ver_cuestionario', cuestionario_id=cuestionario.id_cuestionario) }}"
                       class="action-btn btn-outline">
                        <i class="fas fa-eye"></i>
                        Ver Preguntas
                    </a>

                    <button class="action-btn btn-outline btn-ver-resultados"
                            data-cuestionario-id="{{ cuestionario.id_cuestionario }}"
                            data-cuestionario-titulo="{{ cuestionario.titulo }}"
                            title="Ver historial de salas y resultados">
                        <i class="fas fa-chart-bar"></i>
                        Ver Resultados
                    </button>

                    <a href="{{ url_for('editar_cuestionario', cuestionario_id=cuestionario.id_cuestionario) }}"
                       class="action-btn btn-secondary">
                        <i class="fas fa-edit"></i>
                        Editar
                    </a>
                     </button>

                     <a href="{{ url_for('gestionar_recompensas', id_cuestionario=cuestionario.id_cuestionario) }}"
                     class="action-btn btn-recompensas"
                        title="Administrar las recompensas del cuestionario">
                    <i class="fas fa-gift"></i>
                    Gestionar Recompensas
                    </a>


                    {% if cuestionario.estado == 'borrador' %}
                    <button onclick="publicarCuestionario({{ cuestionario.id_cuestionario }})"
                            class="action-btn btn-success" title="Publicar cuestionario">
                        <i class="fas fa-share"></i>
                        Publicar
                    </button>

                    {% elif cuestionario.estado == 'publicado' %}
                    <a href="{{ url_for('crear_sala_para_cuestionario', cuestionario_id=cuestionario.id_cuestionario) }}"
                       class="action-btn btn-success" title="Crear sala con este cuestionario">
                        <i class="fas fa-users"></i>
                        Crear Sala
                    </a>

                    <button onclick="despublicarCuestionario({{ cuestionario.id_cuestionario }})"
                            class="action-btn btn-warning" title="Despublicar cuestionario">
                        <i class="fas fa-eye-slash"></i>
                        Despublicar
                    </button>



                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state animate-fadeIn">
                <div class="empty-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h2 class="empty-title">No tienes cuestionarios a√∫n</h2>
                <p class="empty-text">Crea tu primer cuestionario para comenzar a evaluar a tus estudiantes de manera interactiva.</p>
                <a href="{{ url_for('crear_cuestionario_route') }}" class="create-btn">
                    <i class="fas fa-plus"></i>
                    Crear Mi Primer Cuestionario
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Modal de Historial de Salas -->
    <div id="modalHistorialSalas" class="modal-overlay" onclick="cerrarModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitulo">
                    <i class="fas fa-history"></i>
                    Historial de Salas
                </h2>
                <button class="modal-close" onclick="cerrarModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="salasContainer">
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #4ECDC4;"></i>
                        <p style="margin-top: 1rem; color: #64748b;">Cargando salas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones de entrada
    const cards = document.querySelectorAll('.quiz-card');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    });

    cards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        observer.observe(card);
    });

    // Event listeners para botones "Ver Resultados"
    const botonesResultados = document.querySelectorAll('.btn-ver-resultados');
    console.log('üîò Botones "Ver Resultados" encontrados:', botonesResultados.length);

    botonesResultados.forEach((btn, index) => {
        console.log(`üîò Bot√≥n ${index + 1}:`, {
            id: btn.getAttribute('data-cuestionario-id'),
            titulo: btn.getAttribute('data-cuestionario-titulo')
        });

        btn.addEventListener('click', function() {
            console.log('üñ±Ô∏è Click en bot√≥n Ver Resultados');
            const cuestionarioId = this.getAttribute('data-cuestionario-id');
            const cuestionarioTitulo = this.getAttribute('data-cuestionario-titulo');
            console.log('üìä Datos del bot√≥n:', { cuestionarioId, cuestionarioTitulo });
            verHistorialSalas(parseInt(cuestionarioId), cuestionarioTitulo);
        });
    });
});

// Funciones para publicar/despublicar cuestionarios
async function publicarCuestionario(cuestionarioId) {
    const confirmed = await confirmAction(
        '¬øEst√°s seguro de que quieres publicar este cuestionario? Una vez publicado, los estudiantes podr√°n acceder a √©l.',
        'Confirmar publicaci√≥n'
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/cuestionarios/${cuestionarioId}/publicar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            await showSuccess('¬°Publicado!', 'El cuestionario est√° ahora disponible para los estudiantes');
            location.reload();
        } else {
            showError('Error', data.error || 'No se pudo publicar el cuestionario');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Error de conexi√≥n', 'No se pudo publicar el cuestionario. Intenta nuevamente.');
    }
}

async function despublicarCuestionario(cuestionarioId) {
    const confirmed = await confirmAction(
        '¬øDespublicar este cuestionario? Los estudiantes ya no podr√°n acceder a √©l.',
        'Confirmar despublicaci√≥n'
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/cuestionarios/${cuestionarioId}/despublicar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            await showSuccess('Despublicado', 'El cuestionario ya no est√° disponible para los estudiantes');
            location.reload();
        } else {
            showError('Error', data.error || 'No se pudo despublicar el cuestionario');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Error de conexi√≥n', 'No se pudo despublicar el cuestionario. Intenta nuevamente.');
    }
}

// Funciones para el modal de historial de salas
async function verHistorialSalas(cuestionarioId, tituloQuestionario) {
    console.log('  INICIO verHistorialSalas');
    console.log('üìä Cuestionario ID:', cuestionarioId);
    console.log('üìù T√≠tulo:', tituloQuestionario);

    const modal = document.getElementById('modalHistorialSalas');
    const modalTitulo = document.getElementById('modalTitulo');
    const salasContainer = document.getElementById('salasContainer');

    console.log('üîç Modal element:', modal);
    console.log('üîç Modal titulo element:', modalTitulo);
    console.log('üîç Salas container element:', salasContainer);

    if (!modal) {
        console.error('‚ùå Modal no encontrado!');
        showError('Error', 'No se encontr√≥ el modal del historial');
        return;
    }

    // Actualizar t√≠tulo
    modalTitulo.innerHTML = `
        <i class="fas fa-history"></i>
        Historial de Salas - ${tituloQuestionario}
    `;

    // Mostrar modal
    console.log('üëÅÔ∏è Mostrando modal...');
    modal.classList.add('active');

    // Mostrar loader
    salasContainer.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #4ECDC4;"></i>
            <p style="margin-top: 1rem; color: #64748b;">Cargando salas...</p>
        </div>
    `;

    try {
        console.log('üåê Fetching:', `/api/cuestionario/${cuestionarioId}/salas`);
        const response = await fetch(`/api/cuestionario/${cuestionarioId}/salas`);
        console.log('üì° Response status:', response.status);
        const data = await response.json();

        console.log('üìã Salas recibidas:', data);

        if (data.success && data.salas && data.salas.length > 0) {
            mostrarListaSalas(data.salas, tituloQuestionario);
        } else {
            salasContainer.innerHTML = `
                <div class="empty-salas">
                    <i class="fas fa-inbox"></i>
                    <h3>No hay salas creadas</h3>
                    <p>A√∫n no se han creado salas con este cuestionario.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå Error al cargar salas:', error);
        salasContainer.innerHTML = `
            <div class="empty-salas" style="color: #ef4444;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error al cargar salas</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function mostrarListaSalas(salas, tituloQuestionario) {
    const salasContainer = document.getElementById('salasContainer');

    const salasHTML = salas.map(sala => {
        const fechaCreacion = new Date(sala.fecha_creacion).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        const estadoClass = `estado-${sala.estado.replace(' ', '_')}`;
        const estadoTexto = sala.estado === 'en_curso' ? 'En Curso' :
                           sala.estado === 'finalizada' ? 'Finalizada' :
                           'Esperando';

        return `
            <div class="sala-item">
                <div class="sala-header-info">
                    <div class="sala-info">
                        <div class="sala-pin">
                            <i class="fas fa-door-open"></i>
                            PIN: ${sala.pin_sala}
                        </div>
                        <div class="sala-meta">
                            <div class="sala-meta-item">
                                <i class="fas fa-calendar"></i>
                                ${fechaCreacion}
                            </div>
                            <div class="sala-meta-item">
                                <i class="fas fa-users"></i>
                                ${sala.total_participantes || 0} participantes
                            </div>
                            <div class="sala-meta-item">
                                <i class="fas fa-question-circle"></i>
                                Modo: ${sala.modo_juego || 'individual'}
                            </div>
                        </div>
                    </div>
                    <span class="sala-estado ${estadoClass}">
                        ${estadoTexto}
                    </span>
                </div>

                ${sala.estado === 'finalizada' ? `
                <div class="sala-actions">
                    <a href="/sala/${sala.id_sala}/resultados"
                       class="sala-btn btn-view-results"
                       title="Ver resultados completos">
                        <i class="fas fa-chart-line"></i>
                        Ver Resultados
                    </a>

                    <div class="btn-export-dropdown">
                        <button class="sala-btn btn-outline"
                                onclick="toggleExportMenu(${sala.id_sala})"
                                id="btn-export-${sala.id_sala}">
                            <i class="fas fa-download"></i>
                            Exportar
                            <i class="fas fa-caret-up"></i>
                        </button>
                        <div class="export-options" id="export-menu-${sala.id_sala}">
                            <button class="export-option"
                                    onclick="exportarSala(${sala.id_sala}, 'csv', '${tituloQuestionario}')">
                                <i class="fas fa-file-csv"></i>
                                Descargar CSV
                            </button>
                            <button class="export-option"
                                    onclick="exportarSala(${sala.id_sala}, 'excel', '${tituloQuestionario}')">
                                <i class="fas fa-file-excel"></i>
                                Descargar Excel
                            </button>
                            <button class="export-option"
                                    onclick="exportarSala(${sala.id_sala}, 'onedrive', '${tituloQuestionario}')">
                                <i class="fab fa-microsoft"></i>
                                Exportar a OneDrive
                            </button>
                        </div>
                    </div>
                </div>
                ` : `
                <div class="sala-actions">
                    <a href="/sala/${sala.id_sala}/juego"
                       class="sala-btn btn-view-results"
                       title="Ir al control de juego">
                        <i class="fas fa-gamepad"></i>
                        ${sala.estado === 'en_curso' ? 'Ir al Juego' : 'Ver Sala'}
                    </a>
                </div>
                `}
            </div>
        `;
    }).join('');

    salasContainer.innerHTML = `<div class="salas-list">${salasHTML}</div>`;
}

function cerrarModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.getElementById('modalHistorialSalas');
        modal.classList.remove('active');
    }
}

function toggleExportMenu(salaId) {
    const menu = document.getElementById(`export-menu-${salaId}`);
    const allMenus = document.querySelectorAll('.export-options');

    // Cerrar otros men√∫s
    allMenus.forEach(m => {
        if (m.id !== `export-menu-${salaId}`) {
            m.classList.remove('active');
        }
    });

    // Toggle este men√∫
    menu.classList.toggle('active');

    event.stopPropagation();
}

// Cerrar men√∫s al hacer clic fuera
document.addEventListener('click', () => {
    document.querySelectorAll('.export-options').forEach(menu => {
        menu.classList.remove('active');
    });
});

async function exportarSala(salaId, formato, cuestionarioTitulo) {
    console.log(`üì• Exportando sala ${salaId} en formato ${formato}`);

    try {
        // Obtener datos del ranking primero
        const rankingResponse = await fetch(`/api/sala/${salaId}/ranking`);
        const rankingData = await rankingResponse.json();

        if (!rankingData.success) {
            showError('Error', 'No se pudieron obtener los datos del ranking');
            return;
        }

        // Obtener info de la sala
        const salaResponse = await fetch(`/api/sala/${salaId}/estado`);
        const salaData = await salaResponse.json();

        const totalPreguntas = salaData.sala?.total_preguntas || 10;

        if (formato === 'csv') {
            exportarCSV(rankingData.ranking, totalPreguntas, cuestionarioTitulo);
        } else if (formato === 'excel') {
            await exportarExcel(salaId, rankingData.ranking, totalPreguntas, cuestionarioTitulo);
        } else if (formato === 'onedrive') {
            await exportarOneDrive(salaId, rankingData.ranking, totalPreguntas, cuestionarioTitulo);
        }

        // Cerrar men√∫
        document.getElementById(`export-menu-${salaId}`).classList.remove('active');

    } catch (error) {
        console.error('‚ùå Error en exportaci√≥n:', error);
        showError('Error de exportaci√≥n', error.message || 'No se pudo exportar los resultados');
    }
}

function exportarCSV(ranking, totalPreguntas, titulo) {
    const csvContent = [
        `Resultados - ${titulo}`,
        `Fecha: ${new Date().toLocaleDateString('es-ES')}`,
        '',
        'Posici√≥n,Nombre,Grupo,Respuestas Correctas,Total Preguntas,Precisi√≥n,Puntuaci√≥n,Tiempo Total',
        ...ranking.map(p => {
            const precision = totalPreguntas > 0 ? Math.round((p.respuestas_correctas / totalPreguntas) * 100) : 0;
            return `${p.posicion},${p.nombre_participante},${p.nombre_grupo || '-'},${p.respuestas_correctas},${totalPreguntas},${precision}%,${p.puntaje_total},${p.tiempo_total_respuestas}s`;
        })
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `resultados_${titulo.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showSuccess('CSV descargado', 'El archivo CSV se descarg√≥ correctamente');
}

async function exportarExcel(salaId, ranking, totalPreguntas, titulo) {
    const response = await fetch(`/api/exportar-resultados/${salaId}/excel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ranking: ranking,
            totalPreguntas: totalPreguntas,
            cuestionarioTitulo: titulo
        })
    });

    if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `resultados_${titulo.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showSuccess('Excel descargado', 'El archivo Excel se descarg√≥ correctamente');
    } else {
        const error = await response.json();
        showError('Error', error.error || 'No se pudo descargar el archivo Excel');
    }
}

async function exportarOneDrive(salaId, ranking, totalPreguntas, titulo) {
    try {
        const response = await fetch(`/api/exportar-resultados/${salaId}/onedrive`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ranking: ranking,
                totalPreguntas: totalPreguntas,
                cuestionarioTitulo: titulo
            })
        });

        const data = await response.json();

        if (data.success) {
            if (data.already_exported) {
                // Archivo ya existe en OneDrive
                let mensaje = `Archivo: ${data.file_name}`;
                if (data.email_sent) {
                    mensaje += '\n\nSe ha enviado el link a tu correo.';
                }
                await showSuccess('Archivo ya exportado', mensaje);
                if (data.web_url) {
                    const openFile = await confirmAction('¬øDeseas abrir el archivo en OneDrive?', 'Abrir archivo');
                    if (openFile) window.open(data.web_url, '_blank');
                }
            } else if (data.fallback) {
                // OneDrive fall√≥, se envi√≥ por email
                showWarning('Enviado por correo', `${data.message}\n\nArchivo: ${data.file_name}\n\nRevisa tu correo.`);
            } else if (data.email_sent) {
                // Solo email (sin intentar OneDrive)
                showSuccess('Enviado por correo', `Archivo: ${data.file_name}`);
            } else if (data.web_url) {
                // Subido exitosamente a OneDrive por primera vez
                await showSuccess('Exportado a OneDrive', `Carpeta: ${data.folder}`);
                const openFile = await confirmAction('¬øDeseas abrir el archivo en OneDrive?', 'Abrir archivo');
                if (openFile) window.open(data.web_url, '_blank');
            } else {
                showSuccess('Exportado', `Archivo: ${data.file_name}`);
            }
        } else if (data.require_auth) {
            // Necesita autorizar OneDrive
            const authorize = await confirmAction(`${data.message}\n\n¬øDeseas autorizar OneDrive ahora?`, 'Autorizaci√≥n requerida');
            if (authorize) window.location.href = data.auth_url;
        } else {
            showError('Error', data.error || 'Error al procesar la solicitud');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Error de conexi√≥n', 'No se pudo procesar la solicitud de exportaci√≥n');
    }
}
</script>
{% endblock %}
