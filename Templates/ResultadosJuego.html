<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados - Brain RUSH</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #FF6B35;
      --secondary-color: #4ECDC4;
      --accent-color: #45B7D1;
      --success-color: #96CEB4;
      --gradient-hero: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      --gradient-primary: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
      --font-primary: 'Fredoka One', cursive;
      --font-secondary: 'Nunito', sans-serif;
      --radius-sm: 0.5rem;
      --radius-md: 1rem;
      --radius-lg: 1.5rem;
      --radius-xl: 2rem;
      --shadow-md: 0 4px 8px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
      --shadow-xl: 0 20px 40px rgba(0,0,0,0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-secondary);
      background: var(--gradient-hero);
      min-height: 100vh;
      color: white;
    }

    .header {
      background: rgba(255, 255, 255, 0.15);
      padding: 30px 20px;
      text-align: center;
      backdrop-filter: blur(20px);
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
      font-family: var(--font-primary);
      font-size: 36px;
      margin-bottom: 12px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .game-info {
      opacity: 0.95;
      font-size: 18px;
      font-weight: 600;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .podium-section {
      margin-bottom: 40px;
    }

    .podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      margin: 40px 0;
      min-height: 300px;
    }

    .podium-place {
      text-align: center;
      position: relative;
      animation: slideUp 1s ease-out;
    }

    .podium-place.first {
      order: 2;
      animation-delay: 0.2s;
    }

    .podium-place.second {
      order: 1;
      animation-delay: 0.4s;
    }

    .podium-place.third {
      order: 3;
      animation-delay: 0.6s;
    }

    .podium-player {
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-lg);
      padding: 25px;
      margin-bottom: 15px;
      backdrop-filter: blur(20px);
      border: 3px solid transparent;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-lg);
    }

    .podium-place.first .podium-player {
      border-color: #FFD700;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
      box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
    }

    .podium-place.second .podium-player {
      border-color: #C0C0C0;
      background: linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(192, 192, 192, 0.1));
      box-shadow: 0 8px 30px rgba(192, 192, 192, 0.3);
    }

    .podium-place.third .podium-player {
      border-color: #CD7F32;
      background: linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(205, 127, 50, 0.1));
      box-shadow: 0 6px 25px rgba(205, 127, 50, 0.3);
    }

    .player-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4CAF50, #66BB6A);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      margin: 0 auto 10px;
      color: white;
    }

    .player-name {
      font-family: var(--font-secondary);
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .player-score {
      font-family: var(--font-primary);
      font-size: 28px;
      font-weight: normal;
      background: var(--gradient-secondary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .podium-base {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: bold;
      color: white;
      position: relative;
    }

    .podium-place.first .podium-base {
      height: 120px;
      width: 120px;
      background: linear-gradient(135deg, #FFD700, #FFA000);
    }

    .podium-place.second .podium-base {
      height: 90px;
      width: 120px;
      background: linear-gradient(135deg, #C0C0C0, #9E9E9E);
    }

    .podium-place.third .podium-base {
      height: 60px;
      width: 120px;
      background: linear-gradient(135deg, #CD7F32, #8D5524);
    }

    .rankings-section {
      margin-top: 40px;
    }

    .section-title {
      font-family: var(--font-primary);
      font-size: 28px;
      font-weight: normal;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .rankings-table {
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(20px);
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow-lg);
    }

    .table-header {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px 20px;
      display: grid;
      grid-template-columns: 60px 1fr 120px 120px 120px;
      gap: 15px;
      font-weight: bold;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table-row {
      padding: 15px 20px;
      display: grid;
      grid-template-columns: 60px 1fr 120px 120px 120px;
      gap: 15px;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: background 0.3s;
    }

    .table-row:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .rank-number {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }

    .rank-number.top3 {
      color: #FFD700;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .player-info .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4CAF50, #66BB6A);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }

    .stat-value {
      text-align: center;
      font-weight: bold;
    }

    .correct-answers {
      color: #4CAF50;
    }

    .accuracy {
      color: #2196F3;
    }

    .final-score {
      color: #FFD700;
      font-size: 18px;
    }

    .rewards-section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-xl);
      padding: 30px;
      margin: 30px 0;
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      animation: slideUp 1.2s ease-out;
    }

    .rewards-section h2 {
      font-family: var(--font-primary);
      font-size: 28px;
      text-align: center;
      margin-bottom: 25px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .rewards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .reward-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
      border-radius: var(--radius-lg);
      padding: 25px;
      text-align: center;
      border: 2px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .reward-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      animation: shimmer 3s infinite;
      pointer-events: none;
    }

    @keyframes shimmer {
      0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
      50% { transform: translate(-50%, -50%) rotate(180deg); }
    }

    .reward-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .reward-card.gold {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      border-color: #FFD700;
    }

    .reward-card.silver {
      background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
      border-color: #C0C0C0;
    }

    .reward-card.bronze {
      background: linear-gradient(135deg, #CD7F32, #B8733E);
      border-color: #CD7F32;
    }

    .reward-icon {
      font-size: 64px;
      margin-bottom: 15px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .reward-name {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .reward-winner {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
      opacity: 0.95;
    }

    .reward-position {
      font-size: 14px;
      opacity: 0.8;
      font-style: italic;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-lg);
      padding: 25px;
      text-align: center;
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-xl);
    }

    .stat-card h3 {
      font-family: var(--font-primary);
      font-size: 32px;
      background: var(--gradient-secondary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .stat-card p {
      opacity: 0.9;
      font-size: 15px;
      font-weight: 600;
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: var(--radius-lg);
      font-family: var(--font-secondary);
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: var(--shadow-md);
    }

    .btn-primary {
      background: var(--gradient-secondary);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-xl);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.6);
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    /* Export dropdown styles */
    .export-dropdown {
      position: relative;
      display: inline-block;
    }

    .export-menu {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      min-width: 220px;
      z-index: 1000;
      overflow: hidden;
    }

    .export-option {
      display: block;
      width: 100%;
      padding: 15px 20px;
      background: transparent;
      border: none;
      color: #333;
      font-family: var(--font-secondary);
      font-size: 15px;
      font-weight: 600;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .export-option:hover {
      background: var(--gradient-secondary);
      color: white;
    }

    .export-option:not(:last-child) {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }

      .podium {
        flex-direction: column;
        align-items: center;
        gap: 15px;
        min-height: auto;
      }

      .podium-place {
        order: unset !important;
        width: 100%;
        max-width: 300px;
      }

      .podium-place .podium-base {
        width: 100%;
        height: 60px;
      }

      .table-header,
      .table-row {
        grid-template-columns: 50px 1fr 80px 80px;
        gap: 10px;
        font-size: 14px;
        padding: 12px 15px;
      }

      .table-header .stat-value:last-child,
      .table-row .stat-value:last-child {
        display: none;
      }

      .player-info .avatar {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }

      .rewards-section {
        padding: 20px;
      }

      .rewards-section h2 {
        font-size: 22px;
      }

      .rewards-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .reward-card {
        padding: 20px;
      }

      .reward-icon {
        font-size: 48px;
      }

      .reward-name {
        font-size: 18px;
      }

      .reward-winner {
        font-size: 16px;
      }

      .actions {
        flex-direction: column;
        align-items: center;
      }

      .btn {
        width: 100%;
        max-width: 300px;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🏆 Resultados Finales</h1>
    <div class="game-info">
      Sala: {{ cuestionario_titulo | default("Brain RUSH Quiz") }} | PIN: {{ sala.pin_sala | default("123456") }}
    </div>
  </div>

  <div class="container">
    <!-- Resultado personal del estudiante (si aplica) -->
    {% if resultado_personal %}
    <div style="background: linear-gradient(135deg, #4CAF50, #66BB6A); border-radius: 16px; padding: 30px; margin-bottom: 40px; text-align: center; box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3); animation: slideUp 0.8s ease-out;">
      <h2 style="font-size: 28px; margin-bottom: 20px;">✨ Tu Resultado</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; max-width: 800px; margin: 0 auto;">
        <div style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
          <div style="font-size: 48px; font-weight: bold; color: #FFD700;">
            #{{ resultado_personal.posicion }}
          </div>
          <div style="font-size: 16px; opacity: 0.9; margin-top: 5px;">Posición</div>
        </div>
        <div style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
          <div style="font-size: 48px; font-weight: bold;">
            {{ resultado_personal.puntaje_total }}
          </div>
          <div style="font-size: 16px; opacity: 0.9; margin-top: 5px;">Puntos</div>
        </div>
        <div style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
          <div style="font-size: 48px; font-weight: bold;">
            {{ resultado_personal.respuestas_correctas }}/{{ resultado_personal.total_preguntas }}
          </div>
          <div style="font-size: 16px; opacity: 0.9; margin-top: 5px;">Correctas</div>
        </div>
        <div style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
          <div style="font-size: 48px; font-weight: bold;">
            {{ "%.1f"|format(resultado_personal.tiempo_total) }}s
          </div>
          <div style="font-size: 16px; opacity: 0.9; margin-top: 5px;">Tiempo</div>
        </div>
      </div>
      <div style="margin-top: 20px; font-size: 18px; opacity: 0.95;">
        {% if resultado_personal.posicion == 1 %}
          🥇 ¡Felicidades! ¡Eres el campeón!
        {% elif resultado_personal.posicion == 2 %}
          🥈 ¡Excelente! ¡Segundo lugar!
        {% elif resultado_personal.posicion == 3 %}
          🥉 ¡Muy bien! ¡Tercer lugar!
        {% else %}
          🎯 ¡Buen trabajo! Sigue mejorando.
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Podium Top 3 -->
    <div class="podium-section">
      <div class="podium" id="podium">
        <!-- Se llenará dinámicamente -->
      </div>
    </div>

    <!-- Recompensas Otorgadas -->
    {% if recompensas_otorgadas and recompensas_otorgadas|length > 0 %}
    <div class="rewards-section">
      <h2>🏆 Recompensas Obtenidas</h2>
      <div class="rewards-grid">
        {% for recompensa in recompensas_otorgadas %}
        <div class="reward-card {% if recompensa.posicion == 1 %}gold{% elif recompensa.posicion == 2 %}silver{% elif recompensa.posicion == 3 %}bronze{% endif %}">
          <div class="reward-icon">
            {% if recompensa.tipo == 'trofeo' %}🏆
            {% elif recompensa.tipo == 'medalla' %}🥇
            {% elif recompensa.tipo == 'insignia' %}🎖️
            {% else %}⭐
            {% endif %}
          </div>
          <div class="reward-name">{{ recompensa.recompensa }}</div>
          <div class="reward-winner">{{ recompensa.nombre_participante }}</div>
          <div class="reward-position">
            {% if recompensa.posicion == 1 %}🥇 Primer Lugar
            {% elif recompensa.posicion == 2 %}🥈 Segundo Lugar
            {% elif recompensa.posicion == 3 %}🥉 Tercer Lugar
            {% else %}Posición {{ recompensa.posicion }}
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Estadísticas generales -->
    <div class="stats-summary">
      <div class="stat-card">
        <h3 id="total-players">{{ total_jugadores | default("8") }}</h3>
        <p>Jugadores participantes</p>
      </div>
      {% if not es_docente and resultado_personal %}
      <div class="stat-card">
        <h3 id="total-questions">{{ resultado_personal.respuestas_correctas }}</h3>
        <p>Respuestas correctas</p>
      </div>
      {% endif %}
      <div class="stat-card">
        <h3 id="avg-score">750</h3>
        <p>Puntuación promedio</p>
      </div>
      <div class="stat-card">
        <h3 id="completion-time">5:23</h3>
        <p>Tiempo total</p>
      </div>
    </div>

    <!-- Tabla completa de rankings -->
    <div class="rankings-section">
      <h2 class="section-title">📊 Clasificación Completa</h2>
      <div class="rankings-table">
        <div class="table-header">
          <div>Pos.</div>
          <div>Jugador</div>
          <div>Correctas</div>
          <div>Precisión</div>
          <div>Puntuación</div>
        </div>
        <div id="rankings-list">
          <!-- Se llenará dinámicamente -->
        </div>
      </div>
    </div>

    <!-- Acciones -->
    <div class="actions">
      {% if es_docente %}
      <a href="/crear-sala" class="btn btn-primary">
        🎮 Nuevo Juego
      </a>
      <a href="/mis-cuestionarios" class="btn btn-secondary">
        📚 Mis Cuestionarios
      </a>
      <div class="export-dropdown">
        <button class="btn btn-secondary" onclick="toggleExportMenu()">
          📊 Exportar Resultados ▼
        </button>
        <div id="export-menu" class="export-menu" style="display: none;">
          <button onclick="exportarCSV()" class="export-option">
            📄 Descargar CSV
          </button>
          <button onclick="exportarExcel()" class="export-option">
            📊 Descargar Excel
          </button>
          <button onclick="exportarOneDrive()" class="export-option">
            📧 Exportar por Email
          </button>
        </div>
      </div>
      {% else %}
      <a href="/estudiante" class="btn btn-primary">
        🏠 Volver al Inicio
      </a>
      <a href="/unirse_a_sala" class="btn btn-secondary">
        🎮 Jugar Otra Sala
      </a>
      {% endif %}
    </div>
  </div>

  <script>
    // Datos reales del servidor
    const ranking = {{ ranking | tojson | safe }};
    const totalPreguntas = {{ sala.total_preguntas | default(0) }};
    const totalJugadores = ranking.length;

    console.log('📊 Datos de resultados:', {
      ranking,
      totalPreguntas,
      totalJugadores
    });

    function initializeResults() {
      cargarPodium();
      cargarTablaCompleta();
      calcularEstadisticas();
    }

    function cargarPodium() {
      const podium = document.getElementById('podium');
      
      if (!ranking || ranking.length === 0) {
        podium.innerHTML = '<p style="text-align: center; padding: 40px; opacity: 0.8;">No hay participantes para mostrar</p>';
        return;
      }
      
      const top3 = ranking.slice(0, 3);
      
      const podiumHTML = top3.map((player, index) => {
        const medals = ['🥇', '🥈', '🥉'];
        const classes = ['first', 'second', 'third'];
        const positions = ['1°', '2°', '3°'];
        
        return `
          <div class="podium-place ${classes[index]}">
            <div class="podium-player">
              <div class="player-avatar">
                ${player.nombre_participante ? player.nombre_participante.charAt(0).toUpperCase() : '?'}
              </div>
              <div class="player-name">${player.nombre_participante || 'Jugador'}</div>
              <div class="player-score">${player.puntaje_total || 0} pts</div>
            </div>
            <div class="podium-base">
              ${positions[index]}
            </div>
          </div>
        `;
      }).join('');
      
      podium.innerHTML = podiumHTML;
    }

    function cargarTablaCompleta() {
      const rankingsList = document.getElementById('rankings-list');
      
      console.log('🔍 Cargando tabla completa. Datos:', {
        ranking,
        totalPreguntas,
        ejemplo: ranking[0]
      });
      
      if (!ranking || ranking.length === 0) {
        rankingsList.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.8;">No hay participantes para mostrar</div>';
        return;
      }
      
      const tablasHTML = ranking.map(player => {
        const precision = totalPreguntas > 0 ? Math.round((player.respuestas_correctas / totalPreguntas) * 100) : 0;
        const isTop3 = player.posicion <= 3;
        
        console.log(`Jugador ${player.nombre_participante}:`, {
          respuestas_correctas: player.respuestas_correctas,
          puntaje_total: player.puntaje_total,
          totalPreguntas,
          precision
        });
        
        return `
          <div class="table-row">
            <div class="rank-number ${isTop3 ? 'top3' : ''}">${player.posicion || '-'}</div>
            <div class="player-info">
              <div class="avatar">${player.nombre_participante ? player.nombre_participante.charAt(0).toUpperCase() : '?'}</div>
              <span>${player.nombre_participante || 'Jugador'}</span>
            </div>
            <div class="stat-value correct-answers">${player.respuestas_correctas || 0}/${totalPreguntas}</div>
            <div class="stat-value accuracy">${precision}%</div>
            <div class="stat-value final-score">${player.puntaje_total || 0}</div>
          </div>
        `;
      }).join('');
      
      rankingsList.innerHTML = tablasHTML;
    }

    function calcularEstadisticas() {
      const avgScore = totalJugadores > 0 ? Math.round(
        ranking.reduce((sum, p) => sum + (p.puntaje_total || 0), 0) / totalJugadores
      ) : 0;
      
      // Calcular tiempo total aproximado (suma de tiempos / jugadores)
      const tiempoTotal = totalJugadores > 0 ?
        ranking.reduce((sum, p) => sum + parseFloat(p.tiempo_total_respuestas || 0), 0) / totalJugadores : 0;
      const minutes = Math.floor(tiempoTotal / 60);
      const seconds = Math.floor(tiempoTotal % 60);
      const completionTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      document.getElementById('total-players').textContent = totalJugadores;
      
      // Solo actualizar si el elemento existe (solo para estudiantes)
      const totalQuestionsElement = document.getElementById('total-questions');
      if (totalQuestionsElement) {
        totalQuestionsElement.textContent = totalPreguntas;
      }
      
      document.getElementById('avg-score').textContent = avgScore;
      document.getElementById('completion-time').textContent = completionTime;
    }

    function toggleExportMenu() {
      const menu = document.getElementById('export-menu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    // Cerrar menú al hacer clic fuera
    document.addEventListener('click', function(event) {
      const dropdown = document.querySelector('.export-dropdown');
      const menu = document.getElementById('export-menu');
      if (dropdown && !dropdown.contains(event.target)) {
        menu.style.display = 'none';
      }
    });

    function exportarCSV() {
      const csvContent = [
        'Posición,Nombre,Respuestas Correctas,Total Preguntas,Precisión,Puntuación,Tiempo Total',
        ...ranking.map(p => {
          const precision = totalPreguntas > 0 ? Math.round((p.respuestas_correctas / totalPreguntas) * 100) : 0;
          return `${p.posicion},${p.nombre_participante},${p.respuestas_correctas},${totalPreguntas},${precision}%,${p.puntaje_total},${p.tiempo_total_respuestas}s`;
        })
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `resultados_brain_rush_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      alert('📄 Archivo CSV descargado correctamente');
      document.getElementById('export-menu').style.display = 'none';
    }

    async function exportarExcel() {
      try {
        const response = await fetch('/api/exportar-resultados/{{ sala.id }}/excel', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ranking: ranking,
            totalPreguntas: totalPreguntas,
            cuestionarioTitulo: '{{ cuestionario_titulo }}'
          })
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `resultados_brain_rush_${new Date().toISOString().split('T')[0]}.xlsx`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          alert('📊 Archivo Excel descargado correctamente');
        } else {
          alert('❌ Error al generar archivo Excel');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al exportar a Excel');
      }
      document.getElementById('export-menu').style.display = 'none';
    }

    async function exportarOneDrive() {
      try {
        const response = await fetch('/api/exportar-resultados/{{ sala.id }}/onedrive', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ranking: ranking,
            totalPreguntas: totalPreguntas,
            cuestionarioTitulo: '{{ cuestionario_titulo }}'
          })
        });

        const data = await response.json();
        
        if (data.success) {
          if (data.fallback) {
            // OneDrive falló, se envió por email
            alert(`⚠️ ${data.message}\n\nArchivo: ${data.file_name}\n\n💡 Revisa tu correo.`);
          } else if (data.email_sent) {
            // Solo email (sin intentar OneDrive)
            alert(`✅ ${data.message}\n\nArchivo: ${data.file_name}`);
          } else if (data.web_url) {
            // Subido exitosamente a OneDrive
            alert(`✅ ${data.message}\n\nCarpeta: ${data.folder}`);
            if (confirm('¿Deseas abrir el archivo en OneDrive?')) {
              window.open(data.web_url, '_blank');
            }
          } else {
            alert(`✅ ${data.message}\n\nArchivo: ${data.file_name}`);
          }
        } else if (data.require_auth) {
          // Necesita autorizar OneDrive
          if (confirm(`${data.message}\n\n¿Deseas autorizar OneDrive ahora?`)) {
            window.location.href = data.auth_url;
          }
        } else {
          alert('❌ ' + (data.error || 'Error al procesar la solicitud'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al procesar la solicitud');
      }
      document.getElementById('export-menu').style.display = 'none';
    }

    // Mantener función legacy para compatibilidad
    function exportarResultados() {
      exportarCSV();
    }

    // Inicializar cuando se carga la página
    document.addEventListener('DOMContentLoaded', initializeResults);
  </script>
</body>
</html>